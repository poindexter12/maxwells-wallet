# Version 0.3 Design Document

## Overview
Version 0.3 focuses on proactive financial management:
- **Budget Tracking**: Set and monitor spending limits
- **Recurring Transaction Detection**: Automatically identify subscriptions and bills
- **Category Rules Engine**: Define custom auto-categorization rules

## Feature 1: Budget Tracking

### User Stories
- As a user, I want to set monthly budgets per bucket, occasion, or account so I can control spending
- As a user, I want to see actual vs budget so I know if I'm overspending
- As a user, I want alerts when approaching budget limits

### Database Schema

```sql
CREATE TABLE budgets (
    id INTEGER PRIMARY KEY,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    tag VARCHAR NOT NULL,             -- namespace:value format (e.g., "bucket:groceries", "occasion:vacation", "account:amex")
    amount FLOAT NOT NULL,            -- Budget limit
    period VARCHAR NOT NULL,          -- 'monthly', 'yearly'
    start_date DATE,                  -- Optional: specific start date
    end_date DATE,                    -- Optional: specific end date
    rollover_enabled BOOLEAN DEFAULT FALSE,

    UNIQUE(tag, period)
);
```

**Note**: Budgets can be set against any tag namespace:
- `bucket:groceries` - Track spending by category
- `occasion:vacation` - Track spending for events
- `account:amex-gold` - Track spending per account

### API Endpoints

#### Budgets
- `GET /api/v1/budgets` - List all budgets
- `GET /api/v1/budgets/{id}` - Get single budget
- `POST /api/v1/budgets` - Create budget
- `PATCH /api/v1/budgets/{id}` - Update budget
- `DELETE /api/v1/budgets/{id}` - Delete budget

#### Budget Analysis
- `GET /api/v1/budgets/status/current` - Get budget status for current month
  - Query params: year, month (optional, defaults to current)
  - Returns: tag, tag_namespace, tag_value, budget_amount, spent_amount, remaining, percentage_used, status (on_track|warning|exceeded), projected_monthly
- `GET /api/v1/budgets/alerts/active` - Get active budget alerts
  - Returns: tags approaching or exceeding budget with alert messages

### Business Logic
- **On Track**: < 80% of budget used
- **Warning**: 80-100% of budget used
- **Exceeded**: > 100% of budget used
- Consider days elapsed in month for better projections

### UI Components
- Budget list with edit/delete actions
- Create/Edit budget form
- Budget status cards on dashboard
- Budget alerts banner

---

## Feature 2: Recurring Transaction Detection

### User Stories
- As a user, I want to see which transactions are recurring so I can track subscriptions
- As a user, I want to predict future recurring transactions
- As a user, I want alerts when expected recurring transaction is missing

### Database Schema

```sql
CREATE TABLE recurring_patterns (
    id INTEGER PRIMARY KEY,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    merchant VARCHAR NOT NULL,
    category VARCHAR,
    amount_min FLOAT,               -- Min amount for fuzzy matching
    amount_max FLOAT,               -- Max amount for fuzzy matching
    frequency VARCHAR NOT NULL,     -- 'weekly', 'monthly', 'quarterly', 'yearly'
    day_of_month INTEGER,           -- Expected day (for monthly)
    day_of_week INTEGER,            -- Expected day (for weekly)
    last_seen_date DATE,            -- Last transaction date
    next_expected_date DATE,        -- Predicted next date
    confidence_score FLOAT,         -- 0-1 confidence in pattern
    status VARCHAR DEFAULT 'active', -- 'active', 'paused', 'ended'

    UNIQUE(merchant, frequency)
);

CREATE TABLE transaction_recurring_links (
    id INTEGER PRIMARY KEY,
    transaction_id INTEGER NOT NULL,
    recurring_pattern_id INTEGER NOT NULL,

    FOREIGN KEY(transaction_id) REFERENCES transactions(id),
    FOREIGN KEY(recurring_pattern_id) REFERENCES recurring_patterns(id)
);
```

### API Endpoints

#### Recurring Patterns
- `GET /api/v1/recurring` - List all recurring patterns
- `GET /api/v1/recurring/{id}` - Get single pattern
- `POST /api/v1/recurring` - Manually create pattern
- `PATCH /api/v1/recurring/{id}` - Update pattern
- `DELETE /api/v1/recurring/{id}` - Delete pattern

#### Detection
- `POST /api/v1/recurring/detect` - Run detection algorithm on existing transactions
  - Returns: newly detected patterns
- `GET /api/v1/recurring/predictions` - Get predicted upcoming recurring transactions
- `GET /api/v1/recurring/missing` - Get expected transactions that haven't appeared

### Detection Algorithm
1. Group transactions by merchant
2. For each merchant with 3+ transactions:
   - Calculate time intervals between transactions
   - Detect patterns:
     - Weekly: ~7 days ±2
     - Monthly: ~30 days ±3
     - Quarterly: ~90 days ±7
     - Yearly: ~365 days ±14
3. Check amount consistency (±10% variance)
4. Calculate confidence score:
   - Number of occurrences (more = higher confidence)
   - Consistency of intervals (lower variance = higher confidence)
   - Amount consistency
5. Create pattern if confidence > 0.7

### UI Components
- Recurring transactions list with filters
- Pattern details view showing transaction history
- "Mark as recurring" button on transactions
- Upcoming recurring transactions widget on dashboard

---

## Feature 3: Category Rules Engine

### User Stories
- As a user, I want to create rules for auto-categorization so transactions are categorized automatically
- As a user, I want rules based on merchant, amount, description patterns
- As a user, I want rules to have priority order

### Database Schema

```sql
CREATE TABLE category_rules (
    id INTEGER PRIMARY KEY,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    name VARCHAR NOT NULL,          -- User-friendly rule name
    category VARCHAR NOT NULL,      -- Target category
    priority INTEGER DEFAULT 0,     -- Higher = applied first
    enabled BOOLEAN DEFAULT TRUE,

    -- Match conditions (at least one must be specified)
    merchant_pattern VARCHAR,       -- Regex or substring
    description_pattern VARCHAR,    -- Regex or substring
    amount_min FLOAT,
    amount_max FLOAT,
    account_source VARCHAR,

    -- Match logic
    match_all BOOLEAN DEFAULT FALSE, -- True: AND logic, False: OR logic

    -- Stats
    match_count INTEGER DEFAULT 0,  -- How many transactions matched
    last_matched_date TIMESTAMP
);
```

### API Endpoints

#### Rules Management
- `GET /api/v1/category-rules` - List all rules (ordered by priority)
- `GET /api/v1/category-rules/{id}` - Get single rule
- `POST /api/v1/category-rules` - Create rule
- `PATCH /api/v1/category-rules/{id}` - Update rule
- `DELETE /api/v1/category-rules/{id}` - Delete rule
- `POST /api/v1/category-rules/{id}/reorder` - Change rule priority

#### Rule Application
- `POST /api/v1/category-rules/apply` - Apply rules to all uncategorized transactions
- `POST /api/v1/category-rules/{id}/test` - Test rule against transactions (preview matches)

### Business Logic
1. **Rule Evaluation Order**: By priority (highest first), then by created_at
2. **Rule Matching**:
   - Check each condition (merchant, description, amount, account)
   - If match_all=true: ALL specified conditions must match
   - If match_all=false: ANY specified condition can match
3. **Auto-categorization Flow**:
   - On import: Apply rules to new transactions
   - On transaction create/update: Re-evaluate rules if category is empty
   - Manual trigger: Apply rules to existing transactions
4. **Pattern Matching**:
   - Merchant/description: Case-insensitive substring match or regex
   - Amount: Within min-max range
   - Account: Exact match

### Updated Category Inference
Modify `backend/app/category_inference.py` to:
1. First check category rules (by priority)
2. Then check user history
3. Then check keyword matching
4. Return suggested category

### UI Components
- Rules list with enable/disable toggles
- Create/Edit rule form with pattern testing
- Rule priority drag-and-drop reordering
- "Apply rules" button on transactions page

---

## Implementation Order

1. **Budget Tracking**
   - ✅ Database migration for budgets table
   - ✅ Backend models and API endpoints
   - ✅ Comprehensive tests
   - ✅ Frontend UI components

2. **Category Rules Engine**
   - ✅ Database migration for category_rules table
   - ✅ Backend models and API endpoints
   - ✅ Update category_inference.py to check rules first
   - ✅ Comprehensive tests
   - ✅ Frontend UI components

3. **Recurring Transaction Detection**
   - ✅ Database migration for recurring_patterns table
   - ✅ Backend detection algorithm
   - ✅ API endpoints
   - ✅ Comprehensive tests
   - ✅ Frontend UI components

---

## Testing Strategy

### Budget Tracking Tests
- Create/read/update/delete budgets
- Budget status calculation (on_track, warning, exceeded)
- Budget alerts generation
- Rollover logic (if implemented)
- Edge cases: negative budgets, zero budgets, missing category

### Category Rules Tests
- Create/read/update/delete rules
- Rule matching logic (AND vs OR)
- Pattern matching (substring, regex)
- Priority ordering
- Apply rules to transactions
- Rule statistics updates

### Recurring Detection Tests
- Detection algorithm with known patterns
- Weekly/monthly/quarterly/yearly detection
- Confidence score calculation
- Amount variance handling
- Missing transaction detection
- Edge cases: irregular patterns, one-time large purchases

---

## Documentation Updates

After implementation, update:
- `FUNCTIONAL_REQUIREMENTS.md` - Add FR-008, FR-009, FR-010
- `TECHNICAL_SPECIFICATIONS.md` - Add new schemas and endpoints
- `README.md` - Add v0.3 features
- `FUTURE_ENHANCEMENTS.md` - Mark implemented, update roadmap
- Create `V0.3_USER_GUIDE.md` - Usage instructions for new features
