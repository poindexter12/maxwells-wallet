name: DAST

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dast:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup mise
        uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2
        with:
          install: true

      - name: Build and start application
        run: |
          just docker::build
          just docker::up

      - name: Wait for application health
        run: |
          echo "Waiting for services to start..."
          sleep 15

          # Health check backend
          for i in {1..10}; do
            if curl -sf http://localhost:3001/health; then
              echo "Backend is healthy"
              break
            fi
            echo "Backend attempt $i failed, retrying..."
            sleep 3
          done

          # Health check frontend
          for i in {1..10}; do
            if curl -sf http://localhost:3000 > /dev/null; then
              echo "Frontend is healthy"
              break
            fi
            echo "Frontend attempt $i failed, retrying..."
            sleep 3
          done

      - name: Show logs if health check failed
        if: failure()
        run: |
          echo "Health checks failed, showing logs:"
          docker compose -f docker-compose.dev.yaml logs
          exit 1

      - name: Initialize application
        run: |
          # Create a test user so the app serves real pages instead of
          # redirecting everything to /setup (302 without Content-Type)
          curl -sf -X POST http://localhost:3001/api/v1/auth/setup \
            -H 'Content-Type: application/json' \
            -d '{"username": "dast-scanner", "password": "DastScan!2026"}' \
            && echo "App initialized with test user" \
            || echo "App initialization failed or already initialized"

      - name: Run ZAP baseline scan
        uses: zaproxy/action-baseline@de8ad967d3548d44ef623df22cf95c3b0baf8b25 # v0.15.0
        with:
          target: 'http://localhost:3000'
          allow_issue_writing: false
          fail_action: false

      - name: Convert ZAP JSON to SARIF
        if: always() && hashFiles('report_json.json') != ''
        run: |
          # Convert ZAP JSON to SARIF, filtering out riskcode=0 (informational)
          # alerts like caching behavior reports, framework detection, and vendor
          # JS comment patterns. Raw ZAP reports (HTML/JSON/MD) still have everything.
          jq '{
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [{
              "tool": {
                "driver": {
                  "name": "OWASP ZAP",
                  "informationUri": "https://www.zaproxy.org/",
                  "rules": [.site[0].alerts[] | select(.riskcode != "0") | {
                    "id": .pluginid,
                    "name": .alert,
                    "shortDescription": { "text": .alert },
                    "fullDescription": { "text": (.desc | gsub("<[^>]+>"; "") | gsub("^\\s+|\\s+$"; "")) },
                    "defaultConfiguration": {
                      "level": (if .riskcode == "3" then "error"
                                elif .riskcode == "2" then "warning"
                                else "note" end)
                    }
                  }]
                }
              },
              "results": [.site[0].alerts[] | select(.riskcode != "0") | . as $alert | .instances[] | {
                "ruleId": $alert.pluginid,
                "level": (if $alert.riskcode == "3" then "error"
                          elif $alert.riskcode == "2" then "warning"
                          else "note" end),
                "message": { "text": ($alert.alert + " at " + .uri) },
                "locations": [{
                  "physicalLocation": {
                    "artifactLocation": {
                      "uri": (.uri | gsub("^https?://[^/]+/?"; "") | if . == "" then "index" else . end)
                    }
                  }
                }]
              }]
            }]
          }' report_json.json > zap-sarif.json

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        if: always() && hashFiles('zap-sarif.json') != ''
        with:
          sarif_file: zap-sarif.json
          category: zap

      - name: Upload ZAP reports as artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: zap-reports
          path: |
            report_json.json
            report_html.html
            report_md.md
            zap-sarif.json
          retention-days: 30

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.dev.yaml down -v --remove-orphans
