name: Security Scans

on:
  workflow_call:
    inputs:
      scan-mode:
        description: 'Scan mode: diff (PR changes only) or full (entire codebase)'
        type: string
        required: false
        default: 'full'

permissions:
  contents: read

jobs:
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    continue-on-error: true
    container:
      image: semgrep/semgrep:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Run Semgrep SAST scan
        run: |
          if semgrep scan --config auto --sarif --output semgrep.sarif .; then
            scan_status="success"
            icon="✅"
          else
            scan_status="completed with findings"
            icon="⚠️"
          fi

          echo "## Semgrep SAST Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$icon Scan $scan_status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -s semgrep.sarif ]; then
            finding_count=$(grep -o '"results"' semgrep.sarif | head -1 || echo "")
            echo "Findings uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  dependency-check:
    name: OWASP Dependency-Check
    if: inputs.scan-mode == 'full'
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Get cache keys
        id: get-date
        run: |
          echo "date=$(date -u '+%Y%m%d')" >> $GITHUB_OUTPUT
          echo "week=$(date -u '+%Y-W%V')" >> $GITHUB_OUTPUT

      - name: Cache NVD database
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: ~/.m2/repository/org/owasp
          key: ${{ runner.os }}-nvd-${{ steps.get-date.outputs.date }}
          restore-keys: |
            ${{ runner.os }}-nvd-

      - name: Cache OWASP Dependency-Check Docker image
        id: cache-dc-image
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: /tmp/dc-image.tar
          key: ${{ runner.os }}-dc-image-${{ steps.get-date.outputs.week }}
          restore-keys: |
            ${{ runner.os }}-dc-image-

      - name: Load cached Docker image
        if: steps.cache-dc-image.outputs.cache-hit == 'true'
        run: docker load -i /tmp/dc-image.tar

      - name: Pull Docker image and save to cache
        if: steps.cache-dc-image.outputs.cache-hit != 'true'
        run: |
          docker pull owasp/dependency-check:latest
          docker save owasp/dependency-check:latest -o /tmp/dc-image.tar

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7
        with:
          version: latest

      - name: Generate requirements.txt for Python scanning
        run: uv pip compile backend/pyproject.toml -o backend/requirements.txt

      - name: Run OWASP Dependency-Check scan
        timeout-minutes: 12
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          NVD_FLAG=""
          if [ -n "$NVD_API_KEY" ]; then
            NVD_FLAG="--nvdApiKey $NVD_API_KEY"
          fi
          mkdir -p reports
          docker run --rm \
            -v $(pwd):/src \
            -v ~/.m2/repository:/usr/share/dependency-check/data \
            owasp/dependency-check:latest \
            --scan /src/frontend/package-lock.json \
            --scan /src/backend/requirements.txt \
            --format SARIF \
            --format HTML \
            --out /src/reports \
            --project "Maxwell's Wallet" \
            $NVD_FLAG \
            --enableExperimental

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        if: always() && hashFiles('reports/dependency-check-report.sarif') != ''
        with:
          sarif_file: reports/dependency-check-report.sarif
          category: dependency-check

      - name: Upload HTML report as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/dependency-check-report.html
          retention-days: 30
