name: Nightly Code Quality

on:
  schedule:
    # Run at 3am UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  security-audit:
    name: Security Audit (pip-audit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@a2a8b00df0aa22a77a33ee5f956c2128661fabeb # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run pip-audit (security scan)
        id: audit
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if uv run pip-audit 2>&1 | tee audit-output.txt; then
            echo "âœ… No known vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat audit-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  dead-code-analysis:
    name: Dead Code Analysis (Vulture)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@a2a8b00df0aa22a77a33ee5f956c2128661fabeb # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run Vulture (dead code detection)
        id: vulture
        run: |
          echo "## Dead Code Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          output=$(uv run vulture app/ --min-confidence 80 2>&1) || true

          if [ -z "$output" ]; then
            echo "âœ… No dead code detected!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Potential dead code found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@a2a8b00df0aa22a77a33ee5f956c2128661fabeb # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run Ruff (linting)
        run: |
          echo "## Linting (Ruff)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if uv run ruff check . 2>&1 | tee ruff-output.txt; then
            echo "âœ… No linting issues!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Linting issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat ruff-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Run MyPy (type checking)
        run: |
          echo "## Type Checking (MyPy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if uv run mypy app --ignore-missing-imports 2>&1 | tee mypy-output.txt; then
            echo "âœ… No type errors!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Type issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat mypy-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  coverage-check:
    name: Coverage Threshold Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install uv
        uses: astral-sh/setup-uv@a2a8b00df0aa22a77a33ee5f956c2128661fabeb # v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run tests with coverage
        run: |
          uv run pytest tests/ --cov=app --cov-report=term --cov-fail-under=85 --ignore=tests/e2e -q

          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Coverage meets 85% threshold" >> $GITHUB_STEP_SUMMARY

  create-issues:
    name: Create Issues for Failures
    runs-on: ubuntu-latest
    needs: [security-audit, dead-code-analysis, code-quality, coverage-check]
    if: always() && contains(needs.*.result, 'failure')

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Create issue for security vulnerabilities
        if: needs.security-audit.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing=$(gh issue list --label "security" --state open --json number --jq 'length')
          if [ "$existing" -gt 0 ]; then
            echo "Security issue already exists, skipping"
            exit 0
          fi

          gh issue create \
            --title "ðŸ”’ Security: Vulnerabilities detected in dependencies" \
            --label "security,automated" \
            --body "## Security Audit Failed

          The nightly security audit detected vulnerabilities in project dependencies.

          **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Next Steps
          1. Review the vulnerabilities in the workflow run
          2. Update affected packages: \`uv lock --upgrade-package <package>\`
          3. If no fix available, assess risk and document in code"

      - name: Create issue for dead code
        if: needs.dead-code-analysis.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing=$(gh issue list --label "dead-code" --state open --json number --jq 'length')
          if [ "$existing" -gt 0 ]; then
            echo "Dead code issue already exists, skipping"
            exit 0
          fi

          gh issue create \
            --title "ðŸ§¹ Cleanup: Dead code detected" \
            --label "dead-code,automated,chore" \
            --body "## Dead Code Analysis Failed

          The nightly dead code analysis (Vulture) found potentially unused code.

          **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Next Steps
          1. Review each item - some may be false positives (e.g., used via reflection)
          2. Remove confirmed dead code
          3. Add to vulture whitelist if intentionally unused"

      - name: Create issue for coverage drop
        if: needs.coverage-check.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing=$(gh issue list --label "coverage" --state open --json number --jq 'length')
          if [ "$existing" -gt 0 ]; then
            echo "Coverage issue already exists, skipping"
            exit 0
          fi

          gh issue create \
            --title "ðŸ“‰ Coverage: Below 85% threshold" \
            --label "coverage,automated,testing" \
            --body "## Coverage Check Failed

          The nightly coverage check found that test coverage has dropped below the 85% threshold.

          **Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Next Steps
          1. Check the workflow run for detailed coverage report
          2. Identify untested code paths
          3. Add tests to restore coverage above 85%"
