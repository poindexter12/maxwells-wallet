name: Devcontainer

on:
  push:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.mise.toml'
  pull_request:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - '.mise.toml'

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build & Test Devcontainer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install devcontainer CLI
        run: |
          cd .github/devcontainer-ci && npm ci
          echo "$GITHUB_WORKSPACE/.github/devcontainer-ci/node_modules/.bin" >> "$GITHUB_PATH"

      - name: Build devcontainer
        run: devcontainer build --workspace-folder .

      - name: Start devcontainer and run tests
        run: |
          # Start the container and capture container ID
          RESULT=$(devcontainer up --workspace-folder . --id-label devcontainer-test=true)
          echo "$RESULT"
          CONTAINER_ID=$(echo "$RESULT" | grep -o '"containerId":"[^"]*"' | cut -d'"' -f4)
          echo "Container ID: $CONTAINER_ID"

          # Use docker exec directly since container might not stay discoverable by devcontainer exec
          # Test mise is installed
          echo "Testing mise..."
          docker exec "$CONTAINER_ID" mise --version || (echo "mise not found" && exit 1)

          # Test Node.js version (installed via mise)
          echo "Testing Node.js..."
          docker exec "$CONTAINER_ID" node --version | grep -q "v22" || (echo "Node.js v22 not found" && exit 1)

          # Test Python version (installed via mise)
          echo "Testing Python..."
          docker exec "$CONTAINER_ID" python --version | grep -q "3.11" || (echo "Python 3.11 not found" && exit 1)

          # Test uv is installed (via mise)
          echo "Testing uv..."
          docker exec "$CONTAINER_ID" uv --version || (echo "uv not found" && exit 1)

          # Test just is installed (via mise)
          echo "Testing just..."
          docker exec "$CONTAINER_ID" just --version || (echo "just not found" && exit 1)

          # Test gum is installed (via mise)
          echo "Testing gum..."
          docker exec "$CONTAINER_ID" gum --version || (echo "gum not found" && exit 1)

          # Test npm is available (comes with node)
          echo "Testing npm..."
          docker exec "$CONTAINER_ID" npm --version || (echo "npm not found" && exit 1)

          echo "All devcontainer tests passed!"

      - name: Cleanup
        if: always()
        run: |
          docker ps -q --filter "label=devcontainer-test=true" | xargs -r docker stop
          docker ps -aq --filter "label=devcontainer-test=true" | xargs -r docker rm
