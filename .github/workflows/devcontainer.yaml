name: Devcontainer

on:
  push:
    branches: [main]
    paths:
      - '.devcontainer/**'
  pull_request:
    branches: [main]
    paths:
      - '.devcontainer/**'

jobs:
  build-and-test:
    name: Build & Test Devcontainer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Build devcontainer
        run: devcontainer build --workspace-folder .

      - name: Start devcontainer and run tests
        run: |
          # Start the container in the background
          devcontainer up --workspace-folder . --id-label devcontainer-test=true

          # Test Node.js version
          echo "Testing Node.js..."
          devcontainer exec --workspace-folder . node --version | grep -q "v22" || (echo "Node.js v22 not found" && exit 1)

          # Test Python version
          echo "Testing Python..."
          devcontainer exec --workspace-folder . python --version | grep -q "3.11" || (echo "Python 3.11 not found" && exit 1)

          # Test uv is installed
          echo "Testing uv..."
          devcontainer exec --workspace-folder . uv --version || (echo "uv not found" && exit 1)

          # Test make is available
          echo "Testing make..."
          devcontainer exec --workspace-folder . make --version || (echo "make not found" && exit 1)

          # Test npm is available
          echo "Testing npm..."
          devcontainer exec --workspace-folder . npm --version || (echo "npm not found" && exit 1)

          echo "âœ… All devcontainer tests passed!"

      - name: Cleanup
        if: always()
        run: |
          docker ps -q --filter "label=devcontainer-test=true" | xargs -r docker stop
          docker ps -aq --filter "label=devcontainer-test=true" | xargs -r docker rm
