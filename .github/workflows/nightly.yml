name: Nightly Code Quality

on:
  schedule:
    # Run at 3am UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  security-audit:
    name: Security Audit (pip-audit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run pip-audit (security scan)
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if uv run pip-audit 2>&1 | tee audit-output.txt; then
            echo "✅ No known vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat audit-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  dead-code-analysis:
    name: Dead Code Analysis (Vulture)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run Vulture (dead code detection)
        run: |
          echo "## Dead Code Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          output=$(uv run vulture app/ --min-confidence 80 2>&1) || true

          if [ -z "$output" ]; then
            echo "✅ No dead code detected!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Potential dead code found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo ""
            echo "Dead code detected:"
            echo "$output"
            exit 1
          fi

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run Ruff (linting)
        run: |
          echo "## Linting (Ruff)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if uv run ruff check . 2>&1 | tee ruff-output.txt; then
            echo "✅ No linting issues!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Linting issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat ruff-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Run MyPy (type checking)
        run: |
          echo "## Type Checking (MyPy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if uv run mypy app --ignore-missing-imports 2>&1 | tee mypy-output.txt; then
            echo "✅ No type errors!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Type issues found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat mypy-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

  coverage-check:
    name: Coverage Threshold Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run tests with coverage
        run: |
          uv run pytest tests/ --cov=app --cov-report=term --cov-fail-under=85 --ignore=tests/e2e -q

          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Coverage meets 85% threshold" >> $GITHUB_STEP_SUMMARY

  chaos-tests:
    name: Chaos Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Create data directory
        working-directory: backend
        run: mkdir -p data

      - name: Initialize database schema
        working-directory: backend
        run: uv run python -m scripts.init_db
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./data/wallet.db"

      - name: Seed database
        working-directory: backend
        run: uv run python -m scripts.seed
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./data/wallet.db"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run chaos tests
        working-directory: frontend
        run: npx playwright test --grep "@chaos" --project=${{ matrix.browser }}
        env:
          CI: true

      - name: Upload chaos test report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: chaos-report-${{ matrix.browser }}
          path: frontend/playwright-report/
          retention-days: 7

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Run performance tests
        working-directory: backend
        run: |
          uv run pytest tests/performance -v -m performance --tb=short

          echo "## Performance Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Performance tests completed" >> $GITHUB_STEP_SUMMARY
        env:
          OTEL_ENABLED: "false"

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: backend/test_perf.db
          retention-days: 7
