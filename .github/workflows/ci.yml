name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Detect what changed to optimize CI
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      docker: ${{ steps.filter.outputs.docker }}
      translations-only: ${{ steps.filter.outputs.translations-only }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
            docker:
              - 'Dockerfile'
              - 'docker-compose*.yaml'
              - 'frontend/Dockerfile'
              - 'backend/Dockerfile'
            translations-only:
              - 'frontend/src/messages/**'
              - '!frontend/src/**/*.ts'
              - '!frontend/src/**/*.tsx'
              - '!backend/**'

  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate pseudo-locale for i18n tests
        run: node scripts/generate-pseudo-locale.mjs

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test:run

      - name: Build
        run: npm run build

  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run linter (ruff)
        run: uv run ruff check .

      - name: Check for dead code (vulture)
        run: uv run vulture app

      - name: Run type checker (mypy)
        run: uv run mypy app

      - name: Run tests with coverage
        run: uv run pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing --ignore=tests/e2e --ignore=tests/performance

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./backend/coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [changes, frontend, backend]
    # Skip E2E for translation-only changes
    if: |
      always() &&
      needs.changes.outputs.translations-only != 'true' &&
      (needs.frontend.result == 'success' || needs.frontend.result == 'skipped') &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Create data directory
        working-directory: backend
        run: mkdir -p data

      # For E2E tests, create schema directly from models (skip migrations)
      # This avoids migration ordering issues and gives us a clean schema
      - name: Initialize database schema
        working-directory: backend
        run: uv run python -m scripts.init_db
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./data/wallet.db"

      - name: Seed database
        working-directory: backend
        run: uv run python -m scripts.seed
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./data/wallet.db"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        working-directory: frontend
        run: npx playwright test --grep "@e2e" --project=chromium
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [changes, backend]
    # Skip performance tests for translation-only or frontend-only changes
    if: |
      always() &&
      needs.changes.outputs.backend == 'true' &&
      needs.backend.result == 'success'

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Run performance tests
        working-directory: backend
        run: |
          uv run pytest tests/performance -v -m performance --tb=short

          echo "## Performance Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Performance tests completed" >> $GITHUB_STEP_SUMMARY
        env:
          OTEL_ENABLED: "false"

      - name: Upload performance results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: performance-results
          path: backend/test_perf.db
          retention-days: 7

  docker:
    name: Docker Build & Smoke Test
    runs-on: ubuntu-latest
    needs: changes
    # Run on Dockerfile/compose changes, or main branch
    if: needs.changes.outputs.docker == 'true' || github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v6

      - name: Build all-in-one image
        run: docker compose build

      - name: Start container
        run: |
          docker compose up -d
          echo "Waiting for services to start..."
          sleep 30

      - name: Health check - Backend
        run: |
          for i in {1..10}; do
            if curl -sf http://localhost:3001/health; then
              echo "Backend is healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Backend health check failed"
          docker compose logs
          exit 1

      - name: Health check - Frontend
        run: |
          for i in {1..10}; do
            if curl -sf http://localhost:3000 > /dev/null; then
              echo "Frontend is healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          echo "Frontend health check failed"
          docker compose logs
          exit 1

      - name: Test Docker commands
        run: |
          # Test migrate command
          docker compose run --rm maxwells-wallet migrate

          # Test seed command
          docker compose run --rm maxwells-wallet seed

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

