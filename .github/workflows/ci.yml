name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate pseudo-locale for i18n tests
        run: node scripts/generate-pseudo-locale.js

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test:run

      - name: Build
        run: npm run build

  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync

      - name: Run linter (ruff)
        run: uv run ruff check .
        continue-on-error: true

      - name: Run type checker (mypy)
        run: uv run mypy app --ignore-missing-imports
        continue-on-error: true

      - name: Run tests with coverage
        run: uv run pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing --ignore=tests/e2e --ignore=tests/performance

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./backend/coverage.xml
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [frontend, backend]

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Create data directory
        working-directory: backend
        run: mkdir -p data

      # For E2E tests, create schema directly from models (skip migrations)
      # This avoids migration ordering issues and gives us a clean schema
      - name: Initialize database schema
        working-directory: backend
        run: uv run python -m scripts.init_db
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./data/wallet.db"

      - name: Seed database
        working-directory: backend
        run: uv run python -m scripts.seed
        env:
          DATABASE_URL: "sqlite+aiosqlite:///./data/wallet.db"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        working-directory: frontend
        run: npx playwright test --grep "@e2e" --project=chromium
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v5
        if: failure()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [backend]

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Run performance tests
        working-directory: backend
        run: |
          uv run pytest tests/performance -v -m performance --tb=short

          echo "## Performance Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Performance tests completed" >> $GITHUB_STEP_SUMMARY
        env:
          OTEL_ENABLED: "false"

      - name: Upload performance results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: performance-results
          path: backend/test_perf.db
          retention-days: 7

