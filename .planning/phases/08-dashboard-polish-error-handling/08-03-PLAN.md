---
phase: 08-dashboard-polish-error-handling
plan: 03
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - frontend/src/contexts/DashboardContext.tsx
  - frontend/src/hooks/useWidgetData.ts
  - frontend/e2e/chaos/chaos-dashboard.spec.ts
autonomous: true
requirements: [DASH-03]

must_haves:
  truths:
    - "Dashboard tabs switch reliably under rapid user clicks without crashes"
    - "Chaos test for tab switching passes (no longer skipped)"
    - "Widget data hooks properly cleanup on dashboard change"
  artifacts:
    - path: "frontend/src/contexts/DashboardContext.tsx"
      provides: "Dashboard context with proper state transition handling"
      contains: "setCurrentDashboard"
    - path: "frontend/src/hooks/useWidgetData.ts"
      provides: "Widget hooks with dependency on currentDashboard"
      contains: "currentDashboard?.id"
    - path: "frontend/e2e/chaos/chaos-dashboard.spec.ts"
      provides: "Chaos test for tab switching (unskipped)"
      pattern: "test\\.skip.*tab switching"
      must_not_contain: "test.skip"
  key_links:
    - from: "frontend/src/hooks/useWidgetData.ts"
      to: "currentDashboard"
      via: "SWR key includes dashboard ID"
      pattern: "dashboard/\\$\\{currentDashboard\\?\\."
    - from: "frontend/src/contexts/DashboardContext.tsx"
      to: "setCurrentDashboard"
      via: "state update batched properly"
      pattern: "setCurrentDashboard"
---

<objective>
Fix dashboard tab switching crash under rapid interaction by ensuring proper state cleanup and SWR cache isolation

Purpose: Dashboard must handle rapid tab switching without undefined behavior or crashes (found by chaos testing)
Output: Fixed DashboardContext state transitions, updated widget hooks with proper dependencies, unskipped passing chaos test
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md

# Phase 7 context - widget structure with SWR
@.planning/phases/07-type-safety-dashboard-extraction/07-01-SUMMARY.md

# Error handling from Plan 01
@.planning/phases/08-dashboard-polish-error-handling/08-01-PLAN.md

# Dashboard context with state management
@frontend/src/contexts/DashboardContext.tsx

# Widget data hooks that may have stale closures
@frontend/src/hooks/useWidgetData.ts

# Chaos test that discovered the bug
@frontend/e2e/chaos/chaos-dashboard.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix DashboardContext state transition handling</name>
  <files>
    frontend/src/contexts/DashboardContext.tsx
  </files>
  <action>
Investigate and fix state management in frontend/src/contexts/DashboardContext.tsx:

**Root Cause Analysis:**
- Review setCurrentDashboard usage and state updates
- Check for stale closures in async operations (refreshDashboards, createDashboard, updateDashboard)
- Verify that currentDashboard state transitions are atomic

**Fixes to apply:**
1. Ensure setCurrentDashboard updates are synchronous and don't race with refreshDashboards
2. Use functional state updates where needed: `setCurrentDashboard(prev => ...)` instead of `setCurrentDashboard(value)`
3. Add proper dependency arrays to useEffect hooks
4. Consider using useCallback for dashboard action methods to prevent recreation
5. If currentDashboard is set from stale dashboards array, use functional update to read latest state

**Pattern to follow:**
```typescript
// BAD (may use stale currentDashboard)
if (!currentDashboard) {
  const defaultDash = data.find((d: Dashboard) => d.is_default) || data[0]
  setCurrentDashboard(defaultDash)
}

// GOOD (reads latest state)
setCurrentDashboard(prev => {
  if (prev) return prev
  return data.find((d: Dashboard) => d.is_default) || data[0]
})
```

**Testing approach:**
- After fixes, test rapid tab switching manually (click tabs quickly 10-20 times)
- Verify no console errors, no undefined dashboard states
- Ensure widgets rerender with correct dashboard data
  </action>
  <verify>
```bash
cd frontend
# Verify functional state updates used
grep -n "setCurrentDashboard(prev" src/contexts/DashboardContext.tsx
# Verify no stale closures in refreshDashboards
grep -A 10 "refreshDashboards" src/contexts/DashboardContext.tsx | grep -q "setCurrentDashboard"
make lint  # Should pass
make build-frontend  # Should compile
```
  </verify>
  <done>
- DashboardContext uses functional state updates for currentDashboard
- No stale closures in async dashboard operations
- State transitions are atomic and race-condition-free
- Build and lint pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update widget hooks with proper dashboard dependency</name>
  <files>
    frontend/src/hooks/useWidgetData.ts
  </files>
  <action>
Update frontend/src/hooks/useWidgetData.ts to properly depend on currentDashboard:

**Root Cause Analysis:**
- Check if SWR keys include currentDashboard.id
- Verify that changing dashboard triggers new SWR fetches
- Ensure no stale data from previous dashboard is shown

**Fixes to apply:**
1. All SWR keys must include currentDashboard?.id to isolate cache per dashboard
2. Pattern:
   ```typescript
   const { data, error, isLoading, mutate } = useSWR<WidgetData>(
     ready && currentDashboard
       ? `/api/v1/reports/widget?dashboard_id=${currentDashboard.id}&...`
       : null,
     fetcher,
     { revalidateOnFocus: false }
   )
   ```
3. Add null check before accessing currentDashboard properties
4. Ensure `ready` flag includes `currentDashboard != null` check

**If dashboard date_range drives widget queries:**
- Extract start_date and end_date from currentDashboard.date_range
- Include in SWR key to ensure refetch when dashboard date range changes
- Pattern: `start_date=${currentDashboard.date_range.start_date}&end_date=${currentDashboard.date_range.end_date}`

**Testing approach:**
- Switch between dashboards with different date ranges
- Verify widgets refetch and show correct data for new dashboard
- No flickering or stale data from previous dashboard
  </action>
  <verify>
```bash
cd frontend
# Verify all SWR keys include currentDashboard?.id
grep -c "currentDashboard\\.id" src/hooks/useWidgetData.ts  # Should be >= 9 (one per hook)
# Verify proper null checks
grep -c "currentDashboard\?" src/hooks/useWidgetData.ts  # Should be > 0
make lint  # Should pass
make build-frontend  # Should compile
```
  </verify>
  <done>
- All widget SWR keys include currentDashboard.id for cache isolation
- Proper null checks before accessing currentDashboard properties
- Dashboard changes trigger widget refetches
- No stale data shown during tab switches
- Build and lint pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Unskip and verify chaos test passes</name>
  <files>
    frontend/e2e/chaos/chaos-dashboard.spec.ts
  </files>
  <action>
Update frontend/e2e/chaos/chaos-dashboard.spec.ts:

1. Remove `test.skip` from tab switching chaos test at line 58
2. Change to `test('tab switching with interleaved actions', ...)`
3. Verify test logic is still valid (no changes needed to test body)
4. Run chaos test locally to verify it passes:
   ```bash
   cd frontend
   npx playwright test chaos/chaos-dashboard.spec.ts --headed
   ```

**Expected behavior:**
- Test performs rapid tab switching with interleaved actions
- No crashes, no undefined states
- All tab switches complete successfully
- Widgets render for each selected dashboard

**If test still fails:**
- Capture browser console logs during failure
- Identify remaining race conditions
- Apply additional fixes to DashboardContext or useWidgetData
- Re-verify test passes before marking task complete

**Test success criteria:**
- Chaos test runs 60 seconds without errors
- Multiple rapid tab switches (10-20) all succeed
- No console errors in browser logs
- Test exits cleanly with PASSED status
  </action>
  <verify>
```bash
cd frontend
# Verify test is no longer skipped
grep -n "test.skip.*tab switching" e2e/chaos/chaos-dashboard.spec.ts && echo "FAILED: still skipped" || echo "PASSED: unskipped"
# Run chaos test
npx playwright test chaos/chaos-dashboard.spec.ts --project=chromium
# Should exit 0 (test passed)
echo $?  # Must be 0
```
  </verify>
  <done>
- Chaos test for tab switching is unskipped (test.skip removed)
- Chaos test passes locally in Chromium
- No console errors during rapid tab switching
- Test demonstrates dashboard reliability under stress
  </done>
</task>

</tasks>

<verification>
1. **DASH-03 (Tab crash fix):** Run chaos test â†’ passes without errors
   ```bash
   cd frontend
   npx playwright test chaos/chaos-dashboard.spec.ts
   ```
2. **Manual verification:** Rapid tab switching (20+ clicks in 5 seconds)
   - No crashes or blank screens
   - Widgets update correctly for each dashboard
   - No console errors
3. **Regression testing:** Run full E2E suite
   ```bash
   make test-e2e  # All dashboard tests pass
   ```
4. **Quality gates:**
   ```bash
   make lint           # Must pass
   make build-frontend # Must compile
   make test-frontend  # All tests pass
   ```
</verification>

<success_criteria>
1. Dashboard tabs switch reliably under rapid user clicks without crashes
2. Chaos test for tab switching passes (unskipped in chaos-dashboard.spec.ts)
3. No console errors during rapid tab switching (verified manually and in E2E)
4. Widget data properly isolates per dashboard (no stale data bleeding between tabs)
5. All quality gates pass
6. No new TypeScript any assertions introduced
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-polish-error-handling/08-03-SUMMARY.md`
</output>
