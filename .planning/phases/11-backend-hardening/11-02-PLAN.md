---
phase: 11-backend-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas.py
  - backend/app/orm.py
  - backend/alembic/versions/*_validation_constraints.py
  - backend/app/main.py
  - backend/app/config.py
autonomous: true
requirements: [BACK-03, BACK-04, BACK-05]

must_haves:
  truths:
    - "Budget amount cannot be negative or zero"
    - "Tag due_day must be between 1 and 28"
    - "CORS origins can be configured via environment variable"
  artifacts:
    - path: "backend/app/schemas.py"
      provides: "Pydantic validation constraints for Budget.amount and Tag.due_day"
      contains: "Field(gt=0)"
      min_lines: 260
    - path: "backend/app/orm.py"
      provides: "Database check constraints for Budget.amount and Tag.due_day"
      contains: "CheckConstraint"
      min_lines: 280
    - path: "backend/alembic/versions/*_validation_constraints.py"
      provides: "Alembic migration adding DB check constraints"
      exports: ["upgrade", "downgrade"]
    - path: "backend/app/config.py"
      provides: "Configuration class with CORS_ORIGINS setting"
      contains: "CORS_ORIGINS"
    - path: "backend/app/main.py"
      provides: "CORS middleware using configurable origins"
      contains: "settings.CORS_ORIGINS"
  key_links:
    - from: "backend/app/schemas.py"
      to: "BudgetCreate.amount"
      via: "Pydantic Field constraint"
      pattern: "amount:.*Field\\(gt=0"
    - from: "backend/app/orm.py"
      to: "Budget table"
      via: "CheckConstraint"
      pattern: "CheckConstraint.*amount > 0"
    - from: "backend/app/main.py"
      to: "backend/app/config.py"
      via: "settings.CORS_ORIGINS"
      pattern: "allow_origins=.*CORS_ORIGINS"
---

<objective>
Add validation constraints for budget amounts, tag due days, and make CORS configurable.

Purpose: Prevent invalid data at both Pydantic (request validation) and database (constraint) layers. Make CORS origins environment-configurable for flexible deployment.

Output: Validated budget/tag fields with dual-layer constraints and configurable CORS origins.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/schemas.py
@backend/app/orm.py
@backend/app/main.py
@backend/app/config.py
</context>

<tasks>

<task type="auto">
  <name>Add Pydantic validation constraints to Budget and Tag schemas</name>
  <files>backend/app/schemas.py</files>
  <action>
Add Pydantic Field constraints for validation:

**1. Import Field from pydantic:**
Add to imports at top of schemas.py (around line 11):
```python
from pydantic import BaseModel, ConfigDict, Field
```

**2. Update BudgetCreate (currently line 260):**
```python
class BudgetCreate(BaseModel):
    tag: str  # namespace:value format
    amount: float = Field(gt=0, description="Budget amount must be positive")
    period: BudgetPeriod = BudgetPeriod.monthly
    start_date: Optional[date_type] = None
    end_date: Optional[date_type] = None
    rollover_enabled: bool = False
```

**3. Update BudgetUpdate (currently line 269):**
```python
class BudgetUpdate(BaseModel):
    tag: Optional[str] = None
    amount: Optional[float] = Field(None, gt=0, description="Budget amount must be positive")
    period: Optional[BudgetPeriod] = None
    start_date: Optional[date_type] = None
    end_date: Optional[date_type] = None
    rollover_enabled: Optional[bool] = None
```

**4. Update TagCreate (currently line 62):**
```python
class TagCreate(BaseModel):
    namespace: str
    value: str
    description: Optional[str] = None
    due_day: Optional[int] = Field(None, ge=1, le=28, description="Due day must be between 1-28")
```

**5. Update TagUpdate (currently line 68):**
```python
class TagUpdate(BaseModel):
    value: Optional[str] = None
    description: Optional[str] = None
    sort_order: Optional[int] = None
    color: Optional[str] = None
    due_day: Optional[int] = Field(None, ge=1, le=28, description="Due day must be between 1-28")
    credit_limit: Optional[float] = None
```

Note: Only add due_day constraint to schemas that accept it as input (TagCreate/TagUpdate). TagResponse doesn't need the constraint since it's output-only.
  </action>
  <verify>grep "Field(gt=0" backend/app/schemas.py should show Budget amount fields; grep "Field(None, ge=1, le=28" should show Tag due_day fields</verify>
  <done>Pydantic schemas enforce positive budget amounts and 1-28 due_day range</done>
</task>

<task type="auto">
  <name>Add database check constraints and configure CORS origins</name>
  <files>backend/app/orm.py, backend/alembic/versions/*_validation_constraints.py, backend/app/config.py, backend/app/main.py</files>
  <action>
**Part 1: Add DB check constraints to ORM models**

In backend/app/orm.py:

**1. Import CheckConstraint (add to imports around line 12):**
```python
from sqlalchemy import (
    String,
    Integer,
    Float,
    Boolean,
    DateTime,
    Date,
    Text,
    ForeignKey,
    UniqueConstraint,
    CheckConstraint,  # Add this
    func,
)
```

**2. Update Budget model (currently line 278):**
```python
class Budget(TimestampMixin, Base):
    """Budget tracking model."""

    __tablename__ = "budgets"
    __table_args__ = (
        CheckConstraint("amount > 0", name="ck_budgets_amount_positive"),
    )

    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    tag: Mapped[str] = mapped_column(String, index=True)
    amount: Mapped[float] = mapped_column(Float)
    period: Mapped[str] = mapped_column(String, default=BudgetPeriod.monthly.value)
    start_date: Mapped[Optional[date_type]] = mapped_column(Date, nullable=True)
    end_date: Mapped[Optional[date_type]] = mapped_column(Date, nullable=True)
    rollover_enabled: Mapped[bool] = mapped_column(Boolean, default=False)
```

**3. Update Tag model (currently line 142):**
```python
class Tag(TimestampMixin, Base):
    """Namespaced tag for flexible transaction classification."""

    __tablename__ = "tags"
    __table_args__ = (
        UniqueConstraint("namespace", "value", name="uq_tags_namespace_value"),
        CheckConstraint("due_day IS NULL OR (due_day >= 1 AND due_day <= 28)", name="ck_tags_due_day_range"),
        {"extend_existing": True},
    )
```

**Part 2: Create Alembic migration for DB constraints**

From backend/ directory, run:
```bash
uv run alembic revision -m "add validation check constraints for budget and tag"
```

Edit the generated migration to add check constraints:

```python
def upgrade() -> None:
    # Add check constraint for Budget.amount
    op.create_check_constraint(
        "ck_budgets_amount_positive",
        "budgets",
        "amount > 0"
    )

    # Add check constraint for Tag.due_day
    op.create_check_constraint(
        "ck_tags_due_day_range",
        "tags",
        "due_day IS NULL OR (due_day >= 1 AND due_day <= 28)"
    )

def downgrade() -> None:
    op.drop_constraint("ck_budgets_amount_positive", "budgets")
    op.drop_constraint("ck_tags_due_day_range", "tags")
```

**Part 3: Make CORS origins configurable**

**3a. Check if config.py exists, if not create it:**

Check for backend/app/config.py. If it doesn't exist, create it:

```python
"""Application configuration from environment variables."""
import os
from typing import List


class Settings:
    """Application settings loaded from environment."""

    # CORS origins - comma-separated list of allowed origins
    # Defaults to localhost:3000 for development
    CORS_ORIGINS: List[str] = [
        origin.strip()
        for origin in os.getenv("CORS_ORIGINS", "http://localhost:3000").split(",")
        if origin.strip()
    ]


settings = Settings()
```

**3b. Update main.py to use configurable CORS origins:**

In backend/app/main.py, import settings and update CORS middleware (currently lines 108-115):

```python
from app.config import settings  # Add this import at top

# ... (in middleware section, replace hardcoded CORS)

# CORS configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```
  </action>
  <verify>
1. grep "CheckConstraint" backend/app/orm.py should show constraints in Budget and Tag models
2. uv run alembic upgrade head should run migration without errors
3. Try creating budget with negative amount via API - should return 422 validation error
4. Try setting tag due_day to 0 or 29 - should return 422 validation error
5. CORS_ORIGINS env var test: CORS_ORIGINS="http://localhost:3000,http://localhost:3001" make backend should allow both origins
  </verify>
  <done>Database check constraints enforce validation rules and CORS origins are configurable via environment variable</done>
</task>

</tasks>

<verification>
Run from backend/ directory:

1. Type check: `uv run mypy app/schemas.py app/orm.py app/main.py --no-error-summary` (no new errors)
2. Migration test: `uv run alembic upgrade head` (no errors)
3. Backend tests: `make test-backend` (existing tests pass)
4. Manual validation tests:
   - POST budget with negative amount → 422 error
   - POST budget with zero amount → 422 error
   - POST tag with due_day=0 → 422 error
   - POST tag with due_day=29 → 422 error
   - POST tag with due_day=15 → 200 success
5. CORS test: Set CORS_ORIGINS env var and verify startup logs show correct origins
</verification>

<success_criteria>
- [ ] BudgetCreate and BudgetUpdate schemas have Pydantic Field(gt=0) constraint
- [ ] TagCreate and TagUpdate schemas have Pydantic Field(ge=1, le=28) constraint
- [ ] Budget table has check constraint enforcing amount > 0
- [ ] Tag table has check constraint enforcing due_day between 1-28 or NULL
- [ ] Alembic migration adds both check constraints successfully
- [ ] CORS_ORIGINS environment variable is read and used in CORSMiddleware
- [ ] Backend tests pass with new validation constraints
- [ ] BACK-03 satisfied: Budget amount validation via Pydantic + DB
- [ ] BACK-04 satisfied: Tag due_day validation enforces 1-28 range
- [ ] BACK-05 satisfied: CORS origins configurable via environment variable
</success_criteria>

<output>
After completion, create `.planning/phases/11-backend-hardening/11-02-SUMMARY.md`
</output>
