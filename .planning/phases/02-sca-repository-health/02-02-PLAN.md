---
phase: 02-sca-repository-health
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/scorecard.yaml
  - .github/workflows/nightly.yaml
autonomous: true
requirements:
  - SCORE-01
  - SCORE-02
  - SCORE-03
  - SCORE-04

must_haves:
  truths:
    - "Scorecard runs in isolated workflow on pushes to main"
    - "Scorecard results appear in GitHub Security tab under 'scorecard' category"
    - "Scorecard workflow has required permissions for publish_results"
    - "Scorecard scan completes without blocking workflow (non-blocking mode)"
  artifacts:
    - path: ".github/workflows/scorecard.yaml"
      provides: "Isolated OpenSSF Scorecard workflow"
      contains: "ossf/scorecard-action"
      min_lines: 40
  key_links:
    - from: ".github/workflows/scorecard.yaml"
      to: "ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a"
      via: "Scorecard action invocation with publish_results: true"
      pattern: "ossf/scorecard-action.*publish_results"
    - from: ".github/workflows/scorecard.yaml"
      to: "github/codeql-action/upload-sarif"
      via: "SARIF upload with category: scorecard"
      pattern: "category:\\s*scorecard"
    - from: ".github/workflows/nightly.yaml"
      to: ".github/workflows/scorecard.yaml"
      via: "Workflow call to run Scorecard on schedule"
      pattern: "uses:.*scorecard\\.yaml"
---

<objective>
Create isolated OpenSSF Scorecard workflow for repository security posture assessment.

Purpose: Add repository security health checks (branch protection, dependency pinning, SAST usage, token permissions, etc.) to complement code and dependency scanning from Phase 1 and Plan 02-01.

Output: scorecard.yaml workflow running on pushes to main and nightly schedule, uploading security posture metrics to GitHub Security tab with unique category.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sca-repository-health/02-RESEARCH.md
@.github/workflows/security.yaml
@.github/workflows/nightly.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create isolated scorecard.yaml workflow</name>
  <files>.github/workflows/scorecard.yaml</files>
  <action>
Create new .github/workflows/scorecard.yaml workflow file. CRITICAL: Scorecard MUST be in its own isolated workflow, NOT embedded in security.yaml.

**Why isolated:** Research Pitfall 2 documents that `publish_results: true` enforces strict GitHub API restrictions:
- No top-level env or defaults blocks
- No workflow-level write permissions
- No containers or services
- Only approved actions: checkout, upload-artifact, codeql-action/upload-sarif, scorecard-action
- Ubuntu runners only (no self-hosted)

Use research-verified pattern from 02-RESEARCH.md > Pattern 2: Isolated Scorecard Workflow.

**Workflow content:**
```yaml
name: OpenSSF Scorecard

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sundays at 2 AM UTC

permissions: read-all

jobs:
  analysis:
    name: Scorecard Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          sarif_file: results.sarif
          category: scorecard

      - name: Upload results artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: scorecard-results
          path: results.sarif
          retention-days: 5

      - name: Create GitHub Step Summary
        if: always()
        run: |
          echo "## OpenSSF Scorecard Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security posture assessment complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
          echo "SARIF artifact available for download" >> $GITHUB_STEP_SUMMARY
```

**Key implementation notes:**
- SHA-pinned actions verified in research: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a (v2.4.3)
- Job-level permissions ONLY (no workflow-level write permissions beyond read-all)
- `id-token: write` REQUIRED for publish_results: true (enables scorecard.dev API integration)
- `persist-credentials: false` in checkout step (security hardening per official example)
- SARIF category: `scorecard` (explicit, following Phase 1 convention - research Open Question 2)
- continue-on-error: true (non-blocking, matches Phase 1 pattern)
- Schedule: Weekly on Sundays at 2 AM UTC (repository health doesn't change frequently)

**Anti-patterns to avoid (from research Pitfall 2):**
- Do NOT add top-level env or defaults blocks
- Do NOT embed in security.yaml (publish_results restrictions will reject)
- Do NOT use workflow-level write permissions
- Do NOT add containers or services
- Do NOT use self-hosted runners
  </action>
  <verify>
1. Check file exists: `ls .github/workflows/scorecard.yaml`
2. Verify SHA-pinned scorecard-action: `grep "ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a" .github/workflows/scorecard.yaml`
3. Confirm publish_results: true: `grep "publish_results: true" .github/workflows/scorecard.yaml`
4. Verify id-token permission: `grep "id-token: write" .github/workflows/scorecard.yaml`
5. Check category is unique: `grep "category: scorecard" .github/workflows/scorecard.yaml`
6. Confirm job-level permissions only: `grep -A5 "analysis:" .github/workflows/scorecard.yaml | grep "permissions:"`
7. Verify no top-level env: `grep -v "^#" .github/workflows/scorecard.yaml | grep -E "^env:" | wc -l` (should be 0)
8. Confirm continue-on-error: `grep "continue-on-error: true" .github/workflows/scorecard.yaml`
9. Validate YAML syntax: `yamllint .github/workflows/scorecard.yaml` or Python yaml.safe_load()
  </verify>
  <done>
.github/workflows/scorecard.yaml exists as isolated workflow with scorecard-action, publish_results: true, required permissions (id-token: write), SARIF upload with category: scorecard, SHA-pinned actions, job-level permissions only, no top-level env/defaults, and continue-on-error: true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Scorecard workflow into nightly schedule</name>
  <files>.github/workflows/nightly.yaml</files>
  <action>
Add Scorecard workflow to nightly.yaml schedule alongside existing security.yaml call.

**Current nightly.yaml structure check:** Read the file to understand existing pattern for calling workflows.

**Add Scorecard job:**
```yaml
  scorecard:
    name: Security Posture (Scorecard)
    uses: ./.github/workflows/scorecard.yaml
```

Place this AFTER the existing security job but BEFORE any test/e2e jobs (security checks before heavier operations).

**Why wire into nightly:** Scorecard already runs on pushes to main (from Task 1). Adding to nightly ensures weekly assessment even during low-activity periods. The workflow's own cron schedule (Sundays 2 AM UTC) provides baseline coverage, but nightly integration ensures consistent daily scanning alongside other security tools.

**Note:** Scorecard workflow call doesn't need inputs (unlike security.yaml which accepts scan-mode). The workflow is parameter-free.
  </action>
  <verify>
1. Check nightly.yaml contains scorecard call: `grep "scorecard.yaml" .github/workflows/nightly.yaml`
2. Verify workflow call syntax: `grep -A2 "scorecard:" .github/workflows/nightly.yaml | grep "uses:"`
3. Confirm placement after security job: Use line numbers to verify scorecard appears after security but before tests
4. Validate YAML syntax: `yamllint .github/workflows/nightly.yaml` or Python yaml.safe_load()
  </verify>
  <done>
.github/workflows/nightly.yaml calls scorecard.yaml workflow via uses: ./.github/workflows/scorecard.yaml, positioned after security job.
  </done>
</task>

</tasks>

<verification>
**Manual verification (recommended after completion):**
1. Push to a branch and open PR to trigger workflows
2. Verify scorecard.yaml does NOT run on PR (only on push to main)
3. Merge PR to main to trigger scorecard workflow
4. Check GitHub Actions run for scorecard.yaml workflow completion (green checkmark or orange warning, not red failure)
5. Navigate to Security tab > Code scanning alerts
6. Confirm scorecard findings appear (typically 10-20 checks: Branch-Protection, Pinned-Dependencies, Token-Permissions, etc.)
7. Check filters show "Tool: Scorecard" option
8. Verify scorecard.dev badge availability (publish_results integration)

**Automated checks:**
- Workflow YAML is valid: GitHub Actions will parse it on push
- SARIF file validates: codeql-action/upload-sarif will reject invalid SARIF
- Scorecard API accepts results: publish_results: true will fail if workflow restrictions violated

**Expected Scorecard checks (10+ repository security metrics):**
- Binary-Artifacts, Branch-Protection, CI-Tests, CII-Best-Practices, Code-Review, Contributors, Dangerous-Workflow, Dependency-Update-Tool, Fuzzing, License, Maintained, Pinned-Dependencies, SAST, Security-Policy, Signed-Releases, Token-Permissions, Vulnerabilities

**Scorecard results interpretation:**
- Scores range 0-10 per check (10 = best)
- Low scores are INFORMATIONAL (non-blocking) — use to improve repo security posture over time
- Common initial low scores: Branch-Protection (if not enforced), Fuzzing (if not implemented), Signed-Releases (if not GPG-signed)
</verification>

<success_criteria>
- [ ] .github/workflows/scorecard.yaml exists as isolated workflow
- [ ] scorecard.yaml runs on pushes to main and weekly schedule (cron)
- [ ] scorecard-action is SHA-pinned to v2.4.3 (4eaacf0543bb3f2c246792bd56e8cdeffafb205a)
- [ ] publish_results: true enabled for scorecard.dev API integration
- [ ] Job has required permissions: security-events: write, id-token: write, contents: read
- [ ] No top-level env or defaults blocks (publish_results restriction)
- [ ] persist-credentials: false in checkout step
- [ ] SARIF upload to GitHub Security tab with category: scorecard
- [ ] SARIF artifact uploaded with 5-day retention
- [ ] Job is non-blocking (continue-on-error: true)
- [ ] nightly.yaml calls scorecard.yaml workflow
- [ ] Workflow is valid YAML and passes GitHub Actions validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-sca-repository-health/02-02-SUMMARY.md`
</output>
