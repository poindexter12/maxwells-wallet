---
phase: 02-sca-repository-health
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - .github/workflows/scorecard.yaml
autonomous: true
requirements: [SCORE-01, SCORE-02, SCORE-03, SCORE-04]
user_setup: []

must_haves:
  truths:
    - "OpenSSF Scorecard runs on pushes to main in an isolated workflow"
    - "Scorecard scans repository security posture (19 checks: token permissions, branch protection, dependency pinning, etc.)"
    - "Scorecard findings appear in GitHub Security tab with unique category: scorecard"
    - "Workflow has correct permissions (contents: read, security-events: write, id-token: write for publish_results)"
    - "Scan completes successfully regardless of score (continue-on-error: true)"
  artifacts:
    - path: ".github/workflows/scorecard.yaml"
      provides: "Isolated workflow for OpenSSF Scorecard SARIF upload"
      must_contain: ["ossf/scorecard-action", "results_format: sarif", "category: scorecard", "id-token: write"]
  key_links:
    - from: "scorecard.yaml"
      to: "GitHub Security tab"
      via: "upload-sarif action"
      pattern: "github/codeql-action/upload-sarif.*category: scorecard"
    - from: "scorecard-action"
      to: "scorecard.dev"
      via: "publish_results: true"
      pattern: "publish_results: true"
---

<objective>
Create an isolated scorecard.yaml workflow to run OpenSSF Scorecard on repository security posture. Scorecard MUST be in its own workflow due to strict API restrictions when publish_results: true is enabled. Scorecard runs on main pushes and produces SARIF output for GitHub Security tab integration.

Purpose: Developers can see repository security health metrics (branch protection, CI/CD security, dependency pinning, token permissions, etc.) in GitHub Security tab, enabling continuous improvement of security hygiene across the entire repository.

Output: New .github/workflows/scorecard.yaml workflow, triggered independently from security.yaml
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sca-repository-health/02-RESEARCH.md
@.planning/phases/02-sca-repository-health/02-CONTEXT.md
@.planning/phases/01-foundation-sast/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create isolated scorecard.yaml workflow with Scorecard job</name>
  <files>.github/workflows/scorecard.yaml</files>
  <action>
Create a NEW workflow file .github/workflows/scorecard.yaml. This workflow MUST be isolated (not embedded in security.yaml) due to publish_results API restrictions enforced by ossf/scorecard-action.

**Workflow structure:**

```yaml
name: OpenSSF Scorecard

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC

permissions: read-all

jobs:
  analysis:
    name: Scorecard Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          sarif_file: results.sarif
          category: scorecard

      - name: Upload results artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: scorecard-results
          path: results.sarif
          retention-days: 5
```

**Key requirements:**

**Workflow-level:**
- Trigger: push to main, schedule (weekly at 2 AM UTC)
- permissions: read-all (workflow-level default, not escalated to write)
- Name must be clearly identifiable as Scorecard

**Job-level:**
- runs-on: ubuntu-latest (required by scorecard-action, no self-hosted or container)
- permissions (job-level, overrides workflow-level read-all):
  - security-events: write (for SARIF upload)
  - id-token: write (for publish_results: true API)
  - contents: read (for code checkout)
- continue-on-error: true (non-blocking, matching Phase 1 pattern)

**Checkout step (critical):**
- Use SHA-pinned actions/checkout@de0fac2e...
- Include persist-credentials: false (Scorecard recommendation for public repos)

**Scorecard step (critical):**
- Use SHA-pinned ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a (v2.4.3)
- results_file: results.sarif (output filename)
- results_format: sarif (GitHub Security tab format)
- publish_results: true (enables scorecard.dev API, requires id-token: write)

**SARIF upload (critical):**
- Use SHA-pinned github/codeql-action/upload-sarif@89a39a4e...
- category: scorecard (unique category, no conflicts with dependency-check or semgrep)

**Artifact upload (secondary):**
- Name: scorecard-results (for human review in Actions artifacts)
- retention-days: 5 (shorter than dependency-check since SARIF is primary output)

**Critical restrictions (enforced by scorecard-action):**
- No top-level env or defaults blocks in workflow
- No containers or services at workflow level
- No custom scripts (only pre-approved actions: checkout, scorecard-action, upload-sarif, upload-artifact)
- Only ubuntu-latest runners (no self-hosted)
- Job-level permissions only (no workflow-level write)

If ANY of these restrictions violated, scorecard-action will fail with validation error.

**Important notes:**
- This is a SEPARATE workflow from security.yaml (not embedded in it)
- No dependencies on security.yaml (runs independently)
- Can run in parallel with security.yaml if both triggered on same push
- publish_results: true enables scoring on scorecard.dev; verify that repo is public or consider disabling if private
  </action>
  <verify>
1. Verify .github/workflows/scorecard.yaml exists:
   ```bash
   test -f .github/workflows/scorecard.yaml && echo "✓ File exists" || echo "✗ File missing"
   ```

2. Parse YAML and validate syntax:
   ```bash
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/scorecard.yaml'))" && \
   echo "✓ YAML syntax valid" || echo "✗ YAML syntax error"
   ```

3. Verify critical fields present:
   ```bash
   grep -E "(name: OpenSSF|push:|main|permissions:|id-token: write|ossf/scorecard-action|results_format: sarif|publish_results: true|category: scorecard)" .github/workflows/scorecard.yaml | wc -l
   # Should output: at least 9 matches
   ```

4. Verify workflow is ISOLATED (not in security.yaml):
   ```bash
   test ! -f .github/workflows/security.yaml || ! grep -q "scorecard" .github/workflows/security.yaml && \
   echo "✓ Scorecard workflow isolated" || echo "✗ Scorecard found in security.yaml (should be separate)"
   ```

5. Verify SHA pinning (no @v2, @v4, or @latest):
   ```bash
   grep -E "uses:.*@(v2|v4|latest|main|master)" .github/workflows/scorecard.yaml | wc -l
   # Should output: 0 (all SHA-pinned)
   ```

6. Verify job-level permissions (not workflow-level):
   ```bash
   grep -A20 "jobs:" .github/workflows/scorecard.yaml | grep -E "^\s{4}permissions:" | wc -l
   # Should output: 1 (job-level, not workflow-level)
   ```

7. Verify continue-on-error:
   ```bash
   grep "continue-on-error: true" .github/workflows/scorecard.yaml && \
   echo "✓ continue-on-error set" || echo "✗ continue-on-error missing"
   ```
  </verify>
  <done>
✓ scorecard.yaml created in .github/workflows/
✓ Workflow structure: push trigger on main, weekly schedule
✓ Job has correct permissions (id-token: write for publish_results)
✓ All Actions SHA-pinned (no @v tags)
✓ Scorecard runs with results_format: sarif and publish_results: true
✓ SARIF upload includes unique category: scorecard
✓ Workflow is isolated (not embedded in security.yaml)
✓ No top-level env/defaults/containers (scorecard-action restrictions honored)
✓ YAML syntax valid
✓ Task completes without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Isolated scorecard.yaml workflow ready to run on main branch</what-built>
  <how-to-verify>
No manual local testing needed. Verification happens via GitHub Actions:

**Trigger workflow:**
1. Push a commit to main (or manually trigger via Actions UI)
2. Go to GitHub repository > Actions tab
3. Should see both "OpenSSF Scorecard" and "[existing CI job name]" workflows listed

**What to check in Scorecard workflow run:**
1. Click "OpenSSF Scorecard" workflow
2. Verify "Scorecard Analysis" job appears in job list
3. Job should succeed (green checkmark) regardless of score
4. In job logs, look for:
   - "Run OpenSSF Scorecard" step completed
   - Results file created: "results.sarif written"
   - SARIF upload step: "Uploaded SARIF file for category: scorecard"
   - Artifact uploaded: "scorecard-results"

**Expected results:**
- Job completes in 30-60 seconds
- No errors in job output
- GitHub Security tab shows new "scorecard" category with repository health metrics (8-19 checks)
- Common findings: missing branch protection, missing SAST, missing signed commits, etc. (these are diagnostic, not blockers)
- Artifact "scorecard-results" available in Actions tab for download

**Important notes:**
- Scorecard only runs on pushes to main (not on PRs)
- Weekly schedule runs every Sunday at 2 AM UTC
- If repo is private, scorecard.dev may not receive publish_results (check scorecard.dev if needed)
- First run will show comprehensive findings; subsequent runs update incrementally

**Abort criteria (stop here if seen):**
- ✗ Job fails with "validation error" (workflow restrictions violated)
- ✗ Scorecard step fails with "ssh-keyscan not supported" (persist-credentials issue)
- ✗ YAML syntax error in workflow parse
- ✗ SARIF upload fails (permissions issue)

If all checks pass, Plan 02 verification complete.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm Scorecard workflow works independently, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 Plan 02 verification (Scorecard integration):

**Must have:**
1. ✓ scorecard.yaml file exists
2. ✓ Workflow triggers on push to main
3. ✓ Workflow has weekly schedule (cron)
4. ✓ Job has permissions: id-token: write (critical for publish_results)
5. ✓ Job has permissions: security-events: write (for SARIF upload)
6. ✓ Job has permissions: contents: read
7. ✓ Job has continue-on-error: true
8. ✓ Scorecard uses results_format: sarif
9. ✓ Scorecard uses publish_results: true
10. ✓ SARIF upload includes category: scorecard (unique, no conflicts)
11. ✓ All Actions SHA-pinned (checkout, scorecard-action, upload-sarif)
12. ✓ No top-level env, defaults, or containers (scorecard-action restrictions)
13. ✓ runs-on: ubuntu-latest (required by scorecard-action)

**No conflicts:**
- scorecard.yaml is separate from security.yaml
- Scorecard triggers independently from CI security jobs
- Category "scorecard" doesn't conflict with "semgrep" or "dependency-check"

**Requirements coverage:**
- SCORE-01: ✓ Scorecard runs on main pushes in isolated workflow
- SCORE-02: ✓ SARIF output with unique category (results_format: sarif, category: scorecard)
- SCORE-03: ✓ Correct permissions (contents: read, security-events: write, id-token: write)
- SCORE-04: ✓ Non-blocking scan (continue-on-error: true)
</verification>

<success_criteria>
Plan 02 complete when:
- [ ] scorecard.yaml created in .github/workflows/ (1 new file)
- [ ] All Actions SHA-pinned
- [ ] Job-level permissions set correctly (including id-token: write)
- [ ] Workflow isolated from security.yaml
- [ ] Checkpoint verification passed (Scorecard job runs successfully in Actions)
- [ ] GitHub Security tab shows scorecard findings/metrics
- [ ] No regressions in existing workflows
- [ ] 1 git commit created with descriptive message

**Definition of done:** Developers can see OpenSSF Scorecard repository health metrics in GitHub Security tab on main pushes, showing comprehensive repository security posture (branch protection, SAST, dependency management, token permissions, etc.).
</success_criteria>

<output>
After completion, create: `.planning/phases/02-sca-repository-health/02-02-SUMMARY.md`

Summary should document:
- What was built (New scorecard.yaml isolated workflow)
- Files created and commits made
- Architecture decision (isolated workflow due to publish_results API restrictions)
- Permission strategy (id-token: write for scorecard.dev API, job-level only)
- Key findings (what Scorecard checks, where findings appear)
- Verification results (CI workflow runs independently, findings in Security tab)
- Requirements satisfied (SCORE-01, 02, 03, 04)
</output>
