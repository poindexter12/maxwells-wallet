---
phase: 02-sca-repository-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/security.yaml
autonomous: true
requirements: [SCA-01, SCA-02, SCA-03, SCA-04]
user_setup:
  - service: nvd-api
    why: "NVD API key accelerates Dependency-Check scans and avoids rate limiting (403 errors)"
    env_vars:
      - name: NVD_API_KEY
        source: "Free registration at https://nvd.nist.gov/developers/request-an-api-key (1-2 day approval)"
    optional: true
    graceful_degradation: "Scans work without key, but slower and rate-limited"

must_haves:
  truths:
    - "Dependency-Check scans npm lockfiles (frontend/package-lock.json)"
    - "Dependency-Check scans Python dependencies (backend requirements or uv.lock conversion)"
    - "NVD database is cached with datetime key (24h TTL) to avoid rate limiting"
    - "Dependency-Check findings appear in GitHub Security tab with unique category: dependency-check"
    - "Scan completes successfully regardless of vulnerabilities found (continue-on-error: true)"
  artifacts:
    - path: ".github/workflows/security.yaml"
      provides: "Extended reusable workflow with Dependency-Check job"
      must_contain: ["dependency-check job", "owasp/dependency-check", "--enableExperimental", "NVD_API_KEY", "category: dependency-check"]
  key_links:
    - from: "security.yaml"
      to: ".github/workflows/ci.yaml"
      via: "workflow_call"
      pattern: "workflow_call"
    - from: "security.yaml"
      to: ".github/workflows/nightly.yaml"
      via: "workflow_call"
      pattern: "workflow_call"
    - from: "dependency-check job"
      to: "GitHub Security tab"
      via: "upload-sarif action"
      pattern: "github/codeql-action/upload-sarif.*category: dependency-check"
---

<objective>
Add OWASP Dependency-Check SCA job to the reusable security.yaml workflow established in Phase 1, with NVD database caching and SARIF output to GitHub Security tab. Dependency-Check scans npm and Python dependencies for known vulnerabilities using the NVD database.

Purpose: Developers can now see application dependency vulnerabilities in GitHub Security tab alongside Semgrep SAST findings, enabling proactive vulnerability management for transitive and direct dependencies.

Output: Extended security.yaml with new dependency-check job, compatible with existing ci.yaml and nightly.yaml callers
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sca-repository-health/02-RESEARCH.md
@.planning/phases/02-sca-repository-health/02-CONTEXT.md
@.planning/phases/01-foundation-sast/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dependency-Check job to security.yaml with NVD caching</name>
  <files>.github/workflows/security.yaml</files>
  <action>
Extend the existing security.yaml reusable workflow with a new dependency-check job. Place it AFTER the existing semgrep job.

**Job structure:**
- Name: "OWASP Dependency-Check"
- Runs on: ubuntu-latest
- Permissions: security-events: write, contents: read (job-level, matching Phase 1 pattern)
- continue-on-error: true (non-blocking, matching Phase 1 pattern)

**Steps (in order):**

1. Checkout code (use Phase 1 SHA-pinned version):
   - Action: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd (v6)

2. Get current datetime for cache key (generates hourly key for 24h TTL):
   - Use: id: get-date
   - Run: echo "datetime=$(date -u '+%Y%m%d%H')" >> $GITHUB_OUTPUT

3. Cache NVD database (restore-keys provides fallback):
   - Action: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 (v4)
   - path: ~/.m2/repository/org/owasp
   - key: ${{ runner.os }}-nvd-${{ steps.get-date.outputs.datetime }}
   - restore-keys: |
       ${{ runner.os }}-nvd-

4. Run Dependency-Check Docker scan (frontend and backend):
   ```bash
   docker run --rm \
     -v $(pwd):/src \
     -v ~/.m2/repository:/usr/share/dependency-check/data \
     owasp/dependency-check:latest \
     --scan /src/frontend/package-lock.json \
     --scan /src/backend \
     --format SARIF \
     --format HTML \
     --out /src/reports \
     --project "Maxwell's Wallet" \
     --nvdApiKey "${NVD_API_KEY}" \
     --enableExperimental
   ```

   Where:
   - --enableExperimental enables Python analyzers (required for backend pip/uv dependencies)
   - --nvdApiKey uses NVD_API_KEY secret if available (gracefully handles empty string)
   - Outputs both SARIF (for Security tab) and HTML (for artifact storage)

5. Upload SARIF to GitHub Security tab:
   - Action: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e (v4.32.4)
   - if: always() (upload even if scan finds vulnerabilities)
   - sarif_file: reports/dependency-check-report.sarif
   - category: dependency-check (unique category, no conflicts with semgrep)

6. Upload HTML report as artifact (for human review):
   - Action: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f (v4)
   - if: always()
   - name: dependency-check-report
   - path: reports/dependency-check-report.html
   - retention-days: 30

**Important notes:**
- All Actions SHA-pinned (following Phase 1 CROSS-03 requirement)
- Docker image: owasp/dependency-check:latest (always has current NVD database)
- Backend scanning: uses /src/backend directory which will auto-detect requirements.txt or equivalent
- If uv.lock exists but no requirements.txt, backend scanning may find nothing — document this limitation for future enhancement (generate requirements.txt from uv.lock)
- NVD_API_KEY secret is optional; scan degrades gracefully (slower, rate-limited)
  </action>
  <verify>
1. Parse .github/workflows/security.yaml and verify:
   - dependency-check job exists after semgrep job
   - job has permissions: {security-events: write, contents: read}
   - job has continue-on-error: true
   - All steps present with correct actions and SHA pins
   - Checkout uses actions/checkout@de0fac2e...
   - Cache uses actions/cache@1bd1e32a...
   - SARIF upload uses github/codeql-action/upload-sarif@89a39a4e...
   - Artifact upload uses actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f

2. Validate YAML syntax (must parse without errors):
   ```bash
   cd /Users/joe/Code/github.com/poindexter12/maxwells-wallet && \
   python3 -c "import yaml; yaml.safe_load(open('.github/workflows/security.yaml'))" && \
   echo "✓ YAML syntax valid"
   ```

3. Verify no duplicate job names:
   ```bash
   grep -E "^  [a-z-]+:$" .github/workflows/security.yaml | sort | uniq -d | wc -l
   # Should output: 0 (no duplicates)
   ```

4. Check that Dependency-Check step references correct docker image:
   ```bash
   grep -A5 "Run Dependency-Check" .github/workflows/security.yaml | grep "owasp/dependency-check"
   # Should contain: owasp/dependency-check:latest
   ```
  </verify>
  <done>
✓ security.yaml extends with dependency-check job
✓ Job structure matches Phase 1 pattern (permissions, continue-on-error)
✓ NVD caching implemented with datetime-based key (24h TTL)
✓ SARIF upload includes unique category: dependency-check
✓ All Actions SHA-pinned
✓ YAML syntax valid, no duplicates
✓ Task completes successfully without blocking other jobs
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Extended security.yaml workflow with Dependency-Check job ready for testing in CI environment</what-built>
  <how-to-verify>
No manual local testing needed for Phase 2. Verification happens via CI:

**Trigger workflow:**
1. Push a commit to main (or manually trigger via Actions UI)
2. Navigate to .github/workflows/security.yaml in the web UI and click "Run workflow" > "Run workflow" button

**What to check in workflow run:**
1. Go to Actions > [workflow run]
2. Verify "OWASP Dependency-Check" job appears in job list (alongside Semgrep)
3. Job should succeed (green checkmark) regardless of vulnerabilities found
4. In job logs, look for:
   - "Checking NVD database cache..." or "Cache hit" message
   - "owasp/dependency-check:latest" running
   - "--enableExperimental" flag in docker run command
   - SARIF report created: "report.sarif written successfully"
   - Artifact uploaded: "Uploading artifact dependency-check-report"

**Expected results:**
- Dependency-Check job completes in 30-120 seconds (faster if NVD cache hit)
- No errors in job output (even if vulnerabilities found, job succeeds)
- GitHub Security tab shows new "dependency-check" category with findings (if any)
- Artifact "dependency-check-report" available for download

**If cache misses (first run):**
- Expect longer duration (2-5 minutes) as NVD data downloads
- This is normal; subsequent runs will hit cache

**If NVD_API_KEY not configured:**
- Scan still succeeds but may take longer
- Look for log line about NVD API key (empty string handled gracefully)

**Abort criteria (stop here if seen):**
- ✗ Job fails with "docker: command not found"
- ✗ Job fails with "Unable to create cache" (permission issue)
- ✗ YAML syntax error in workflow parse
- ✗ Artifact upload fails (storage issue)

If all checks pass, proceed to next step.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm Dependency-Check job works in CI, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 2 Plan 01 verification (Dependency-Check integration):

**Must have:**
1. ✓ security.yaml contains dependency-check job
2. ✓ Job has permissions: security-events: write, contents: read
3. ✓ Job has continue-on-error: true
4. ✓ NVD cache step present with datetime key
5. ✓ Docker run command includes --enableExperimental (Python support)
6. ✓ SARIF upload includes category: dependency-check
7. ✓ All Actions SHA-pinned (no @v6, @v4, or @latest tags for actions)
8. ✓ Artifact upload for HTML report present
9. ✓ Job integrates with existing CI/nightly callers (no changes needed to ci.yaml or nightly.yaml)

**No regressions:**
- semgrep job unchanged in security.yaml
- ci.yaml call to security.yaml unchanged
- nightly.yaml call to security.yaml unchanged

**Requirements coverage:**
- SCA-01: ✓ Dependency-Check scans npm and pip (--scan /src/frontend /src/backend, --enableExperimental)
- SCA-02: ✓ SARIF output with unique category (--format SARIF, category: dependency-check)
- SCA-03: ✓ NVD caching with datetime TTL (actions/cache with hourly key)
- SCA-04: ✓ Non-blocking scan (continue-on-error: true)
</verification>

<success_criteria>
Plan 01 complete when:
- [ ] security.yaml modified with dependency-check job (1 file changed)
- [ ] All Actions SHA-pinned
- [ ] Job-level permissions set correctly
- [ ] NVD caching implemented with 24h TTL (hourly key granularity)
- [ ] Checkpoint verification passed (CI workflow runs successfully)
- [ ] GitHub Security tab shows dependency-check findings (if any)
- [ ] No regressions in existing semgrep job or CI/nightly integrations
- [ ] 1 git commit created with descriptive message

**Definition of done:** Developers can see Dependency-Check findings in GitHub Security tab on main branch pushes, with NVD database cached for performance and cost control.
</success_criteria>

<output>
After completion, create: `.planning/phases/02-sca-repository-health/02-01-SUMMARY.md`

Summary should document:
- What was built (Dependency-Check job extension to security.yaml)
- Files modified and commits made
- Integration pattern (extends Phase 1 workflow, no ci.yaml/nightly.yaml changes needed)
- Key decisions (NVD caching strategy, --enableExperimental for Python, category naming)
- Verification results (CI workflow runs, findings appear in Security tab)
- Requirements satisfied (SCA-01, 02, 03, 04)
</output>
