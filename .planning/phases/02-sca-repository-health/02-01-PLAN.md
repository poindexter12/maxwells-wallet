---
phase: 02-sca-repository-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/security.yaml
  - backend/requirements.txt
autonomous: true
requirements:
  - SCA-01
  - SCA-02
  - SCA-03
  - SCA-04

must_haves:
  truths:
    - "Dependency-Check scans both frontend (npm) and backend (Python) dependencies on pushes to main"
    - "Dependency-Check findings appear in GitHub Security tab under 'dependency-check' category"
    - "NVD database is cached between runs to avoid rate limiting"
    - "Dependency-Check scan completes without blocking workflow (non-blocking mode)"
  artifacts:
    - path: ".github/workflows/security.yaml"
      provides: "dependency-check job extending reusable workflow"
      contains: "dependency-check:"
      min_lines: 80
    - path: "backend/requirements.txt"
      provides: "Python dependencies in pip-compatible format for Dependency-Check"
      min_lines: 10
  key_links:
    - from: ".github/workflows/security.yaml"
      to: "owasp/dependency-check:latest"
      via: "Docker container invocation"
      pattern: "owasp/dependency-check"
    - from: ".github/workflows/security.yaml"
      to: "github/codeql-action/upload-sarif"
      via: "SARIF upload with category: dependency-check"
      pattern: "category:\\s*dependency-check"
    - from: ".github/workflows/security.yaml"
      to: "actions/cache"
      via: "NVD database caching with datetime key"
      pattern: "actions/cache.*nvd"

user_setup:
  - service: NVD (National Vulnerability Database)
    why: "Accelerate dependency vulnerability scanning and avoid rate limits"
    env_vars:
      - name: NVD_API_KEY
        source: "https://nvd.nist.gov/developers/request-an-api-key (free, 1-2 day approval)"
        optional: true
        fallback: "Scan works without key but is slower and may hit rate limits"
---

<objective>
Add OWASP Dependency-Check SCA scanning to security.yaml workflow for npm and Python dependency vulnerability detection.

Purpose: Extend Phase 1's security workflow with Software Composition Analysis (SCA) to detect vulnerabilities in third-party dependencies, complementing existing Dependabot alerts with NVD database coverage.

Output: Dependency-Check job in security.yaml scanning frontend/package-lock.json and backend/requirements.txt, uploading SARIF to GitHub Security tab with unique category, caching NVD database for performance.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sca-repository-health/02-RESEARCH.md
@.github/workflows/security.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate requirements.txt from uv.lock for Dependency-Check compatibility</name>
  <files>backend/requirements.txt</files>
  <action>
Generate requirements.txt from backend/uv.lock using uv pip compile.

**Why this is needed:** Research Pitfall 4 identified that OWASP Dependency-Check's experimental pip analyzer ONLY supports files named exactly "requirements.txt". It does NOT support uv.lock, pyproject.toml, poetry.lock, or Pipfile formats. Without this file, backend Python dependencies will not be scanned.

Run from repository root:
```bash
cd backend
uv pip compile pyproject.toml -o requirements.txt
```

Add brief header comment to requirements.txt explaining it's generated for OWASP Dependency-Check:
```
# Generated from pyproject.toml for OWASP Dependency-Check compatibility
# DO NOT edit manually - regenerate with: uv pip compile pyproject.toml -o requirements.txt
```

**Important:** This file should be committed to git (not .gitignored) so it's available in CI without requiring uv installation in the Dependency-Check job.
  </action>
  <verify>
1. Check file exists: `ls backend/requirements.txt`
2. Verify it contains pinned dependencies: `grep "==" backend/requirements.txt | head -5`
3. Confirm header comment present: `head -2 backend/requirements.txt`
4. Ensure at least 10 dependencies listed (FastAPI, SQLModel, etc.): `wc -l backend/requirements.txt`
  </verify>
  <done>
backend/requirements.txt exists with header comment and pinned Python dependencies matching pyproject.toml (minimum 10 packages).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add OWASP Dependency-Check job to security.yaml workflow</name>
  <files>.github/workflows/security.yaml</files>
  <action>
Add dependency-check job to .github/workflows/security.yaml after the existing semgrep job.

Follow Phase 1 patterns:
- Job-level permissions (not workflow-level): `security-events: write`, `contents: read`
- continue-on-error: true (non-blocking)
- SHA-pinned actions with version comments
- GitHub Step Summary output

Use research-verified pattern from 02-RESEARCH.md > Pattern 1: Dependency-Check Job in Reusable Workflow.

**Job structure:**
```yaml
  dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Get datetime for cache key
        id: get-date
        run: echo "datetime=$(date -u '+%Y%m%d%H')" >> $GITHUB_OUTPUT

      - name: Cache NVD database
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        with:
          path: ~/.m2/repository/org/owasp
          key: ${{ runner.os }}-nvd-${{ steps.get-date.outputs.datetime }}
          restore-keys: |
            ${{ runner.os }}-nvd-

      - name: Run Dependency-Check scan
        run: |
          mkdir -p reports
          docker run --rm \
            -v $(pwd):/src \
            -v ~/.m2/repository:/usr/share/dependency-check/data \
            owasp/dependency-check:latest \
            --scan /src/frontend/package-lock.json \
            --scan /src/backend/requirements.txt \
            --format SARIF \
            --format HTML \
            --out /src/reports \
            --project "Maxwell's Wallet" \
            --nvdApiKey "${{ secrets.NVD_API_KEY || '' }}" \
            --enableExperimental

          if [ $? -eq 0 ]; then
            scan_status="success"
            icon="✅"
          else
            scan_status="completed with findings"
            icon="⚠️"
          fi

          echo "## OWASP Dependency-Check Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$icon Scan $scan_status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -s reports/dependency-check-report.sarif ]; then
            echo "Findings uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
            echo "HTML report available in artifacts" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        if: always()
        with:
          sarif_file: reports/dependency-check-report.sarif
          category: dependency-check

      - name: Upload HTML report as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/dependency-check-report.html
          retention-days: 30
```

**Key implementation notes:**
- `--enableExperimental` flag is REQUIRED for Python scanning (research Pitfall 3)
- Datetime-based cache key with 24h TTL (not dependency-based) per research Pattern 3
- `secrets.NVD_API_KEY || ''` allows graceful degradation if secret not configured
- Both `--scan` paths required: frontend/package-lock.json (npm) and backend/requirements.txt (Python)
- Docker volume mount: `-v ~/.m2/repository:/usr/share/dependency-check/data` for NVD cache persistence
- SARIF category: `dependency-check` (unique, following Phase 1 convention)

**Anti-patterns to avoid (from research):**
- Do NOT use dependency-based cache key (keeps NVD data stale)
- Do NOT omit --enableExperimental (Python deps won't be scanned)
- Do NOT use dependency-check GitHub Action wrapper (less control, Phase 1 uses native Docker)
  </action>
  <verify>
1. Check job exists in workflow: `grep "dependency-check:" .github/workflows/security.yaml`
2. Verify SHA-pinned actions: `grep -E "uses:.*@[a-f0-9]{40}" .github/workflows/security.yaml | grep -E "(cache|upload-sarif|upload-artifact)"`
3. Confirm --enableExperimental flag: `grep "enableExperimental" .github/workflows/security.yaml`
4. Verify both scan paths: `grep -E "scan.*/src/(frontend|backend)" .github/workflows/security.yaml`
5. Check category is unique: `grep "category: dependency-check" .github/workflows/security.yaml`
6. Confirm job-level permissions: `grep -A2 "dependency-check:" .github/workflows/security.yaml | grep "permissions:"`
7. Verify non-blocking: `grep "continue-on-error: true" .github/workflows/security.yaml | wc -l` (should be 2: semgrep + dependency-check)
  </verify>
  <done>
.github/workflows/security.yaml contains dependency-check job with all required elements: NVD caching, both scan paths, SARIF upload with unique category, HTML artifact upload, SHA-pinned actions, job-level permissions, continue-on-error, and --enableExperimental flag.
  </done>
</task>

</tasks>

<verification>
**Manual verification (recommended after completion):**
1. Push to a branch and open PR to trigger security.yaml workflow
2. Check GitHub Actions run completes successfully with both semgrep and dependency-check jobs
3. Verify dependency-check job shows in workflow run with green checkmark (or orange warning if findings, but not red failure)
4. Navigate to Security tab > Code scanning alerts
5. Confirm dependency-check findings appear (may be zero initially, that's OK)
6. Check filters show "Tool: Dependency-Check" option
7. Download HTML artifact from workflow run and verify it contains both npm and Python packages

**Automated checks:**
- Workflow YAML is valid: GitHub Actions will parse it on push
- SARIF file validates: codeql-action/upload-sarif will reject invalid SARIF
- NVD cache effectiveness: Compare first run duration (5+ min) vs subsequent runs (<1 min)

**NVD API Key setup (user action, documented in user_setup):**
If NVD_API_KEY secret not configured, scan will work but may hit rate limits. To add:
1. Request free API key: https://nvd.nist.gov/developers/request-an-api-key
2. Wait for email approval (1-2 days)
3. Add to repository: Settings > Secrets and variables > Actions > New repository secret
4. Name: `NVD_API_KEY`, Value: `{key from email}`
</verification>

<success_criteria>
- [ ] backend/requirements.txt exists and contains pinned Python dependencies
- [ ] .github/workflows/security.yaml contains dependency-check job
- [ ] dependency-check job scans both frontend/package-lock.json and backend/requirements.txt
- [ ] NVD database caching configured with datetime-based key (24h TTL)
- [ ] SARIF upload to GitHub Security tab with category: dependency-check
- [ ] HTML report uploaded as workflow artifact
- [ ] Job uses SHA-pinned actions matching Phase 1 convention
- [ ] Job has job-level permissions (security-events: write, contents: read)
- [ ] Job is non-blocking (continue-on-error: true)
- [ ] --enableExperimental flag present for Python scanning
- [ ] NVD_API_KEY secret usage configured with graceful degradation
- [ ] Workflow is valid YAML and passes GitHub Actions validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-sca-repository-health/02-01-SUMMARY.md`
</output>
