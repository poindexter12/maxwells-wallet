---
phase: 02-sca-repository-health
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/security.yaml
autonomous: true
requirements:
  - SCA-01
  - SCA-02
  - SCA-03
  - SCA-04

must_haves:
  truths:
    - "Dependency-Check scans npm (package-lock.json) and Python (generated requirements.txt) dependencies on pushes to main"
    - "Dependency-Check findings appear in GitHub Security tab with unique category 'dependency-check'"
    - "NVD database is cached with 24h TTL to avoid rate limiting"
    - "Scan completes successfully regardless of vulnerability findings (non-blocking)"
  artifacts:
    - path: ".github/workflows/security.yaml"
      provides: "dependency-check job with NVD caching, Python/npm scanning, SARIF upload"
      contains: "dependency-check:"
  key_links:
    - from: ".github/workflows/security.yaml"
      to: "owasp/dependency-check Docker image"
      via: "docker run command in job step"
      pattern: "docker run.*owasp/dependency-check"
    - from: ".github/workflows/security.yaml"
      to: "github/codeql-action/upload-sarif"
      via: "SARIF upload step with category: dependency-check"
      pattern: "category: dependency-check"
    - from: ".github/workflows/security.yaml"
      to: "NVD database cache"
      via: "actions/cache with datetime-based key"
      pattern: "actions/cache.*nvd"

user_setup:
  - service: NVD (National Vulnerability Database)
    why: "Optional API key accelerates NVD database updates and avoids rate limits"
    env_vars:
      - name: NVD_API_KEY
        source: "Free registration at https://nvd.nist.gov/developers/request-an-api-key (1-2 day approval)"
        required: false
        fallback: "Scan works without key but slower and may hit rate limits"
    dashboard_config:
      - task: "Request API key"
        location: "NVD website → Developers → Request an API Key"
        note: "Free, requires email verification, 1-2 day approval time"
---

<objective>
Add OWASP Dependency-Check SCA scanning to the reusable security.yaml workflow to detect vulnerabilities in npm and Python dependencies, outputting findings to GitHub Security tab.

Purpose: Extend Phase 1's security infrastructure with dependency scanning against the NVD database. Dependency-Check provides additive coverage to existing Dependabot alerts by scanning against a different vulnerability database.

Output: Modified security.yaml with new dependency-check job that scans frontend/package-lock.json and backend dependencies (via generated requirements.txt), caches NVD database with 24h TTL, and uploads SARIF with category 'dependency-check'.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sca-repository-health/02-CONTEXT.md
@.planning/phases/02-sca-repository-health/02-RESEARCH.md
@.planning/phases/01-foundation-sast/01-01-SUMMARY.md
@.github/workflows/security.yaml
@backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Add dependency-check job to security.yaml with NVD caching and dual-language scanning</name>
  <files>.github/workflows/security.yaml</files>
  <action>
Add new `dependency-check` job to security.yaml after the existing `semgrep` job. Follow Phase 1 patterns exactly:
- Job-level permissions: `security-events: write`, `contents: read`
- `continue-on-error: true` for non-blocking execution
- All actions SHA-pinned per CROSS-04 requirement

Job steps:
1. Checkout code using `actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6`
2. Generate datetime for cache key: `echo "datetime=$(date -u '+%Y%m%d%H')" >> $GITHUB_OUTPUT`
3. Cache NVD database using `actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4`
   - Path: `~/.m2/repository/org/owasp`
   - Key: `${{ runner.os }}-nvd-${{ steps.get-date.outputs.datetime }}`
   - Restore keys: `${{ runner.os }}-nvd-`
4. Generate requirements.txt from backend pyproject.toml (CRITICAL: Dependency-Check does NOT support uv.lock)
   - Install uv: `curl -LsSf https://astral.sh/uv/install.sh | sh`
   - Generate: `uv pip compile backend/pyproject.toml -o backend/requirements.txt`
5. Run Dependency-Check scan using native Docker container (not GitHub Action wrapper, per Phase 1 pattern)
   - Image: `owasp/dependency-check:latest`
   - Mount volumes: `-v $(pwd):/src` and `-v ~/.m2/repository:/usr/share/dependency-check/data`
   - Scan paths: `--scan /src/frontend/package-lock.json --scan /src/backend/requirements.txt`
   - Output formats: `--format SARIF --format HTML`
   - Output directory: `--out /src/reports`
   - Project name: `--project "Maxwell's Wallet"`
   - NVD API key with graceful degradation: `--nvdApiKey ${{ secrets.NVD_API_KEY || '' }}`
   - REQUIRED for Python: `--enableExperimental`
6. Upload SARIF using `github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4`
   - File: `reports/dependency-check-report.sarif`
   - Category: `dependency-check` (unique identifier per CROSS-01)
   - Condition: `if: always()` to upload even if scan fails
7. Upload HTML report as artifact using `actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4`
   - Name: `dependency-check-report`
   - Path: `reports/dependency-check-report.html`
   - Retention: 30 days
   - Condition: `if: always()`

DO NOT modify the existing semgrep job. DO NOT modify workflow triggers or inputs. DO NOT add workflow-level permissions (job-level only per Phase 1 pattern).
  </action>
  <verify>
```bash
# Validate YAML syntax
yamllint .github/workflows/security.yaml

# Verify structure
grep -q "dependency-check:" .github/workflows/security.yaml
grep -q "enableExperimental" .github/workflows/security.yaml
grep -q "category: dependency-check" .github/workflows/security.yaml
grep -q "actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57" .github/workflows/security.yaml

# Verify SHA pinning
! grep -E "uses:.*@(v[0-9]|latest|main)" .github/workflows/security.yaml || echo "ERROR: Found unpinned actions"
```
  </verify>
  <done>
security.yaml contains dependency-check job with:
- NVD caching configured with datetime-based key
- requirements.txt generation from pyproject.toml
- Docker invocation scanning both frontend and backend
- SARIF upload with category 'dependency-check'
- HTML artifact upload
- All actions SHA-pinned
- Job-level permissions and continue-on-error: true
  </done>
</task>

</tasks>

<verification>
After implementation:
1. Workflow YAML passes syntax validation
2. dependency-check job exists with all required steps
3. All third-party actions are SHA-pinned (no @v tags)
4. Job has continue-on-error: true and job-level permissions
5. NVD caching uses datetime-based key pattern
6. Python scanning includes --enableExperimental flag
7. SARIF upload includes category: dependency-check
</verification>

<success_criteria>
- Modified security.yaml parses without errors
- dependency-check job follows Phase 1 patterns (SHA pins, job-level permissions, non-blocking)
- Job scans both npm (package-lock.json) and Python (generated requirements.txt)
- NVD database caching configured with 24h TTL
- SARIF uploads to GitHub Security tab with unique category
- HTML report uploads as artifact for human review
</success_criteria>

<output>
After completion, create `.planning/phases/02-sca-repository-health/02-01-SUMMARY.md` documenting:
- Modified files (.github/workflows/security.yaml)
- Dependency-Check configuration choices
- NVD caching strategy
- requirements.txt generation approach
- Verification results
- Requirements satisfied (SCA-01 through SCA-04)
</output>
