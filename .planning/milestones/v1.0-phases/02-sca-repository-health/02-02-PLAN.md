---
phase: 02-sca-repository-health
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/scorecard.yaml
autonomous: true
requirements:
  - SCORE-01
  - SCORE-02
  - SCORE-03
  - SCORE-04

must_haves:
  truths:
    - "OpenSSF Scorecard runs on pushes to main in an isolated workflow"
    - "Scorecard produces repository security posture metrics visible in GitHub Security tab"
    - "Scorecard workflow uses required permissions (contents: read, security-events: write, id-token: write)"
    - "Scan completes successfully regardless of score (non-blocking)"
  artifacts:
    - path: ".github/workflows/scorecard.yaml"
      provides: "Isolated Scorecard workflow with publish_results enabled"
      contains: "ossf/scorecard-action"
  key_links:
    - from: ".github/workflows/scorecard.yaml"
      to: "ossf/scorecard-action"
      via: "Scorecard action invocation with publish_results: true"
      pattern: "ossf/scorecard-action@"
    - from: ".github/workflows/scorecard.yaml"
      to: "github/codeql-action/upload-sarif"
      via: "SARIF upload step with category: scorecard"
      pattern: "category: scorecard"
---

<objective>
Create isolated OpenSSF Scorecard workflow to assess repository security posture and upload metrics to GitHub Security tab.

Purpose: Add repository health scoring to complement vulnerability scanning. Scorecard evaluates 19+ security practices (branch protection, token permissions, dependency pinning, SAST usage, etc.) and must run in an isolated workflow due to strict publish_results API restrictions.

Output: New scorecard.yaml workflow that runs on pushes to main and weekly schedule, executes Scorecard with publish_results enabled, and uploads SARIF with category 'scorecard'.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sca-repository-health/02-CONTEXT.md
@.planning/phases/02-sca-repository-health/02-RESEARCH.md
@.planning/phases/01-foundation-sast/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create scorecard.yaml isolated workflow with strict publish_results compliance</name>
  <files>.github/workflows/scorecard.yaml</files>
  <action>
Create new workflow file `.github/workflows/scorecard.yaml` following official OpenSSF Scorecard pattern with strict restrictions enforced by publish_results: true.

CRITICAL: Scorecard's publish_results API enforces workflow validation. Violations cause API rejection. Required structure:

**Workflow triggers:**
```yaml
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sundays at 2 AM UTC
```

**Permissions:**
- Workflow-level: `permissions: read-all`
- Job-level (REQUIRED for publish_results):
  - `security-events: write` (SARIF upload)
  - `id-token: write` (OIDC token for Scorecard API)
  - `contents: read` (repository access)

**Restrictions (violations cause API rejection):**
- NO top-level `env:` block
- NO top-level `defaults:` block
- NO workflow-level write permissions (read-all only)
- NO containers or services in job
- ONLY approved actions: `actions/checkout`, `actions/upload-artifact`, `github/codeql-action/upload-sarif`, `ossf/scorecard-action`
- Ubuntu runners only (no self-hosted)

**Job structure:**
```yaml
jobs:
  analysis:
    name: Scorecard Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          sarif_file: results.sarif
          category: scorecard

      - name: Upload results artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: scorecard-results
          path: results.sarif
          retention-days: 5
```

Follow Phase 1 SHA-pinning convention with version comments. Use `continue-on-error: true` for non-blocking execution per SCORE-04.

DO NOT embed this in security.yaml. DO NOT add additional jobs or steps. DO NOT use workflow-level write permissions.
  </action>
  <verify>
```bash
# Validate YAML syntax
yamllint .github/workflows/scorecard.yaml

# Verify structure
grep -q "ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a" .github/workflows/scorecard.yaml
grep -q "publish_results: true" .github/workflows/scorecard.yaml
grep -q "category: scorecard" .github/workflows/scorecard.yaml
grep -q "id-token: write" .github/workflows/scorecard.yaml
grep -q "persist-credentials: false" .github/workflows/scorecard.yaml

# Verify NO top-level env or defaults (violations)
! grep -q "^env:" .github/workflows/scorecard.yaml || echo "ERROR: Top-level env found (violates publish_results)"
! grep -q "^defaults:" .github/workflows/scorecard.yaml || echo "ERROR: Top-level defaults found (violates publish_results)"

# Verify SHA pinning
! grep -E "uses:.*@(v[0-9]|latest|main)" .github/workflows/scorecard.yaml || echo "ERROR: Found unpinned actions"
```
  </verify>
  <done>
scorecard.yaml exists as isolated workflow with:
- Triggers on push to main and weekly schedule
- Workflow-level permissions: read-all
- Job-level permissions: security-events: write, id-token: write, contents: read
- Scorecard action with publish_results: true
- SARIF upload with category 'scorecard'
- Artifact upload for SARIF results
- All actions SHA-pinned
- continue-on-error: true
- NO top-level env or defaults blocks
- persist-credentials: false on checkout
  </done>
</task>

</tasks>

<verification>
After implementation:
1. Workflow file exists at .github/workflows/scorecard.yaml
2. YAML passes syntax validation
3. All required permissions present (id-token: write critical for publish_results)
4. No top-level env or defaults blocks (violate publish_results restrictions)
5. All actions SHA-pinned
6. persist-credentials: false on checkout
7. SARIF upload includes category: scorecard
8. continue-on-error: true for non-blocking execution
</verification>

<success_criteria>
- scorecard.yaml created and parses without errors
- Workflow complies with all publish_results restrictions (no env/defaults, approved actions only, job-level permissions)
- Scorecard action configured with publish_results: true
- SARIF uploads to GitHub Security tab with unique category
- Weekly schedule ensures regular security posture assessment
- Non-blocking execution via continue-on-error: true
</success_criteria>

<output>
After completion, create `.planning/phases/02-sca-repository-health/02-02-SUMMARY.md` documenting:
- Created file (.github/workflows/scorecard.yaml)
- publish_results restrictions and compliance
- Permission requirements (id-token: write for OIDC)
- Trigger strategy (push to main + weekly schedule)
- Verification results
- Requirements satisfied (SCORE-01 through SCORE-04)
</output>
