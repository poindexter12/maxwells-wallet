---
phase: 03-container-scanning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yaml
autonomous: true
requirements:
  - CNTR-01
  - CNTR-02
  - CNTR-03
  - CNTR-04

must_haves:
  truths:
    - "Trivy scans the locally built Docker image after docker compose build completes"
    - "Trivy detects vulnerabilities in both OS packages (apt) and application dependencies (npm, pip)"
    - "Trivy findings appear in GitHub Security tab with unique category 'trivy-container'"
    - "Docker image pushes to GHCR regardless of Trivy findings (non-blocking scan)"
  artifacts:
    - path: ".github/workflows/ci.yaml"
      provides: "Trivy scan steps in docker job between build and push"
      contains: "aquasecurity/trivy-action"
  key_links:
    - from: ".github/workflows/ci.yaml docker job"
      to: "aquasecurity/trivy-action"
      via: "Trivy scan step after build, before push"
      pattern: "aquasecurity/trivy-action@"
    - from: ".github/workflows/ci.yaml docker job"
      to: "github/codeql-action/upload-sarif"
      via: "SARIF upload step with category: trivy-container"
      pattern: "category: trivy-container"
    - from: "Trivy scan"
      to: "locally built Docker image"
      via: "image-ref pointing to docker-compose-built image"
      pattern: "image-ref:.*maxwells-wallet"
---

<objective>
Add Trivy container scanning to the docker job in ci.yaml to detect OS package and application dependency vulnerabilities in the production Docker image before pushing to GHCR.

Purpose: Extend Phase 1/2 security infrastructure with container image scanning. Trivy provides visibility into vulnerabilities present in the final deployed artifact (OS packages from python:3.12-slim base, npm dependencies, pip dependencies).

Output: Modified ci.yaml docker job with Trivy scan steps that run after image build, scan the locally built all-in-one image, upload SARIF to GitHub Security tab with category 'trivy-container', and allow GHCR push to proceed regardless of findings.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-sast/01-01-SUMMARY.md
@.planning/phases/02-sca-repository-health/02-01-PLAN.md
@.github/workflows/ci.yaml
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Add Trivy container scan steps to docker job in ci.yaml</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
Modify the `docker` job in ci.yaml to add Trivy container scanning between the build and push steps. Insert new steps after "Build all-in-one image" step (line ~230) and before "Set up Docker Buildx" step (line ~259).

Add these steps in sequence:

1. **Run Trivy scan** using aquasecurity/trivy-action (SHA-pinned)
   - Action: `aquasecurity/trivy-action@6e3dd3b4eebcf9f238e32e883f2c4c4c54713e3a # v0.30.0`
   - Inputs:
     - `scan-type: 'image'` (scan container image, not filesystem)
     - `image-ref: 'maxwells-wallet:latest'` (local image built by docker-compose, not GHCR path)
     - `format: 'sarif'` (output SARIF for GitHub Security tab)
     - `output: 'trivy-results.sarif'` (file path for SARIF output)
     - `severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'` (all severities for visibility)
   - `continue-on-error: true` (non-blocking per CNTR-04)

2. **Upload Trivy SARIF** using github/codeql-action/upload-sarif
   - Action: `github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4`
   - Inputs:
     - `sarif_file: 'trivy-results.sarif'`
     - `category: 'trivy-container'` (unique identifier, distinct from 'semgrep' and 'dependency-check')
   - `if: always()` (upload even if Trivy step fails)

CRITICAL implementation notes:
- Place steps BEFORE "Set up Docker Buildx" (which has `if: github.ref == 'refs/heads/main'`) so Trivy runs on ALL builds (PRs and main)
- Use `image-ref: 'maxwells-wallet:latest'` NOT the GHCR path - this scans the locally built image from docker-compose
- DO NOT add job-level permissions (docker job already has `packages: write` which includes required permissions)
- DO NOT modify existing steps (build, smoke test, push steps must remain unchanged)
- DO NOT add workflow-level changes (triggers, inputs, permissions)

Follow Phase 1/2 patterns:
- SHA-pinned actions (no @v0.30.0 or @latest tags in final YAML)
- Non-blocking execution (continue-on-error: true on scan step)
- Unique SARIF category ('trivy-container')
- Upload on failure (if: always() on upload step)
  </action>
  <verify>
```bash
# Validate YAML syntax
yamllint .github/workflows/ci.yaml

# Verify Trivy integration
grep -q "aquasecurity/trivy-action@" .github/workflows/ci.yaml
grep -q "scan-type: 'image'" .github/workflows/ci.yaml
grep -q "image-ref: 'maxwells-wallet:latest'" .github/workflows/ci.yaml
grep -q "category: trivy-container" .github/workflows/ci.yaml

# Verify SHA pinning (no @v tags)
! grep -E "aquasecurity/trivy-action@v[0-9]" .github/workflows/ci.yaml || echo "ERROR: trivy-action not SHA-pinned"

# Verify positioning (Trivy before buildx setup)
TRIVY_LINE=$(grep -n "aquasecurity/trivy-action" .github/workflows/ci.yaml | cut -d: -f1)
BUILDX_LINE=$(grep -n "docker/setup-buildx-action" .github/workflows/ci.yaml | cut -d: -f1)
[ "$TRIVY_LINE" -lt "$BUILDX_LINE" ] && echo "OK: Trivy runs before buildx" || echo "ERROR: Trivy after buildx"

# Verify continue-on-error and if: always() present
grep -A 5 "aquasecurity/trivy-action" .github/workflows/ci.yaml | grep -q "continue-on-error: true"
grep -A 3 "upload-sarif" .github/workflows/ci.yaml | grep -q "if: always()"
```
  </verify>
  <done>
ci.yaml docker job includes Trivy scan steps that:
- Run after docker compose build, before GHCR push
- Scan the local maxwells-wallet:latest image
- Upload SARIF with category 'trivy-container'
- Use SHA-pinned aquasecurity/trivy-action
- Execute non-blocking (continue-on-error: true)
- Upload results even on failure (if: always())
  </done>
</task>

<task type="auto">
  <name>Verify Trivy detects OS and application vulnerabilities</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
Validate that Trivy configuration will scan all vulnerability types required by CNTR-02:

1. Verify image-ref points to the correct local image name:
   - Check docker-compose.dev.yaml for the service name and image naming pattern
   - Confirm Trivy's image-ref matches the locally built image tag

2. Confirm Trivy's default behavior includes:
   - OS package scanning (apt packages from python:3.12-slim base)
   - Application dependency scanning (npm from frontend build, pip from backend)
   - No need for additional flags - Trivy scans both by default with scan-type: 'image'

3. Verify SARIF category uniqueness:
   - Read .github/workflows/security.yaml to confirm existing categories
   - Ensure 'trivy-container' doesn't conflict with 'semgrep' or 'dependency-check'

NO code changes in this task - verification and documentation only. If any issues found, note them in task output for manual correction.
  </action>
  <verify>
```bash
# Check docker-compose image name
grep -A 5 "services:" docker-compose.dev.yaml | grep -A 3 "maxwells-wallet"

# Verify existing SARIF categories don't conflict
grep "category:" .github/workflows/security.yaml .github/workflows/ci.yaml | sort | uniq

# Confirm no duplicate category
CATEGORIES=$(grep "category:" .github/workflows/security.yaml .github/workflows/ci.yaml | awk '{print $NF}' | sort)
UNIQUE=$(echo "$CATEGORIES" | uniq | wc -l)
TOTAL=$(echo "$CATEGORIES" | wc -l)
[ "$UNIQUE" -eq "$TOTAL" ] && echo "OK: All categories unique" || echo "ERROR: Duplicate categories found"
```
  </verify>
  <done>
Verified that:
- Trivy image-ref matches docker-compose service image name
- Trivy scan-type: 'image' detects both OS packages and application dependencies
- SARIF category 'trivy-container' is unique (no conflicts with existing categories)
- Configuration meets CNTR-02 requirement (OS + app dependency scanning)
  </done>
</task>

</tasks>

<verification>
After implementation:
1. ci.yaml parses without YAML syntax errors
2. Trivy scan steps exist in docker job between build and push
3. aquasecurity/trivy-action is SHA-pinned (no @v tags)
4. Trivy scans image-ref: 'maxwells-wallet:latest' (local image)
5. SARIF uploads with category: 'trivy-container' (unique)
6. Trivy step has continue-on-error: true
7. SARIF upload has if: always()
8. Trivy runs on all builds (before conditional GHCR push)
9. No changes to existing docker job steps (build, smoke test, push unchanged)
</verification>

<success_criteria>
- Modified ci.yaml parses without errors
- Trivy scans the locally built Docker image after build, before push to GHCR
- Trivy scan configured to detect OS packages and application dependencies
- SARIF uploads to GitHub Security tab with unique category 'trivy-container'
- Docker image push proceeds regardless of Trivy findings (non-blocking)
- All third-party actions SHA-pinned per Phase 1/2 patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-container-scanning/03-01-SUMMARY.md` documenting:
- Modified file (.github/workflows/ci.yaml docker job)
- Trivy configuration choices (image-ref, scan-type, severity levels)
- Integration point (between build and push steps)
- SARIF category selection ('trivy-container')
- Verification results
- Requirements satisfied (CNTR-01 through CNTR-04)
</output>
