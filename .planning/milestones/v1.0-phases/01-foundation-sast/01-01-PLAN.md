---
phase: 01-foundation-sast
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/security.yaml
  - .github/workflows/ci.yaml
  - .github/workflows/nightly.yaml
autonomous: true
requirements:
  - CROSS-01
  - CROSS-02
  - CROSS-03
  - CROSS-04
  - CROSS-05
  - SAST-01
  - SAST-02
  - SAST-03
  - SAST-04
  - SAST-05

must_haves:
  truths:
    - "security.yaml is a reusable workflow callable via workflow_call"
    - "Semgrep scans TypeScript and Python using --config auto in a native Docker container"
    - "SARIF output uploads to GitHub Security tab with category 'semgrep'"
    - "All third-party Actions are pinned to commit SHAs"
    - "Semgrep job uses continue-on-error: true (non-blocking)"
    - "ci.yaml calls security.yaml on PRs and pushes to main"
    - "nightly.yaml calls security.yaml for full nightly scans"
    - "Job-level permissions follow least privilege (security-events: write, contents: read)"
  artifacts:
    - path: ".github/workflows/security.yaml"
      provides: "Reusable security workflow with Semgrep SAST job"
      contains: "workflow_call"
    - path: ".github/workflows/ci.yaml"
      provides: "CI workflow calling security.yaml"
      contains: "security.yaml"
    - path: ".github/workflows/nightly.yaml"
      provides: "Nightly workflow calling security.yaml"
      contains: "security.yaml"
  key_links:
    - from: ".github/workflows/ci.yaml"
      to: ".github/workflows/security.yaml"
      via: "uses: ./.github/workflows/security.yaml"
      pattern: "uses:.*security\\.yaml"
    - from: ".github/workflows/nightly.yaml"
      to: ".github/workflows/security.yaml"
      via: "uses: ./.github/workflows/security.yaml"
      pattern: "uses:.*security\\.yaml"
    - from: ".github/workflows/security.yaml"
      to: "github/codeql-action/upload-sarif"
      via: "SARIF upload step with category: semgrep"
      pattern: "category: semgrep"
---

<objective>
Create the reusable security scanning workflow (security.yaml) with Semgrep SAST and wire it into the existing CI and nightly pipelines.

Purpose: Establish the security scanning infrastructure that all subsequent phases (SCA, container, DAST) will extend. Semgrep findings become visible in GitHub Security tab immediately.
Output: Three workflow files — one new (security.yaml), two modified (ci.yaml, nightly.yaml)
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-sast/01-RESEARCH.md
@.planning/phases/01-foundation-sast/01-CONTEXT.md
@.github/workflows/ci.yaml
@.github/workflows/nightly.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable security.yaml workflow with Semgrep SAST job</name>
  <files>.github/workflows/security.yaml</files>
  <action>
Create `.github/workflows/security.yaml` as a reusable workflow with the following structure:

**Trigger:** `workflow_call` with one input:
- `scan-mode` (string, optional, default: `full`) — values: `diff` or `full`. This input is accepted for future use (diff-aware scanning in Phase 6) but does not change behavior in this phase. Both modes run a full scan.

**Workflow-level permissions:** `contents: read` (restrictive default).

**Job: `semgrep`**
- `name: Semgrep SAST`
- `runs-on: ubuntu-latest`
- `permissions:` (job-level, least privilege)
  - `security-events: write` (for SARIF upload)
  - `contents: read`
- `continue-on-error: true` (non-blocking — workflow succeeds even if Semgrep finds issues or crashes)
- `container: image: semgrep/semgrep:latest` (native Docker, NOT semgrep-action wrapper)

**Steps:**
1. **Checkout code** — `actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd` (v6, SHA already used in repo)

2. **Run Semgrep SAST scan** — shell step:
   ```bash
   if semgrep scan --config auto --sarif --output semgrep.sarif .; then
     scan_status="success"
     icon="✅"
   else
     scan_status="completed with findings"
     icon="⚠️"
   fi

   echo "## Semgrep SAST Scan" >> $GITHUB_STEP_SUMMARY
   echo "" >> $GITHUB_STEP_SUMMARY
   echo "$icon Scan $scan_status" >> $GITHUB_STEP_SUMMARY
   echo "" >> $GITHUB_STEP_SUMMARY

   if [ -s semgrep.sarif ]; then
     finding_count=$(grep -o '"results"' semgrep.sarif | head -1 || echo "")
     echo "Findings uploaded to Security tab" >> $GITHUB_STEP_SUMMARY
   fi
   ```
   Use `semgrep scan` (NOT `semgrep ci` which requires AppSec Platform account).
   Use `--config auto` for automatic language detection and community rules (SAST-02).
   Use `--sarif --output semgrep.sarif` for SARIF output (SAST-03).

3. **Upload SARIF to GitHub Security tab** — `github/codeql-action/upload-sarif@89a39a4e59826350b863aa6b6252a07ad50cf83e` (v4.32.4)
   - `if: always()` (upload even if scan step returned non-zero)
   - `sarif_file: semgrep.sarif`
   - `category: semgrep` (unique category per CROSS-02, required by July 2025 GitHub policy)

Key constraints:
- Do NOT use the deprecated `returntocorp/semgrep-action` wrapper
- Do NOT use `semgrep ci` command (requires platform account)
- Do NOT set workflow-level `security-events: write` (least privilege at job level only)
  </action>
  <verify>
Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/security.yaml'))"`

Verify key patterns exist in the file:
- `workflow_call` trigger
- `container:` with `semgrep/semgrep:latest`
- `semgrep scan --config auto --sarif`
- `category: semgrep`
- `continue-on-error: true`
- `security-events: write` at job level
- SHA-pinned actions (no `@v6` or `@latest` tags)
  </verify>
  <done>
security.yaml exists with: workflow_call trigger, Semgrep job running in native Docker container, --config auto --sarif flags, SARIF upload with category "semgrep", job-level permissions (security-events: write, contents: read), continue-on-error: true, all Actions SHA-pinned, and job summary output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire security.yaml into ci.yaml and nightly.yaml</name>
  <files>.github/workflows/ci.yaml, .github/workflows/nightly.yaml</files>
  <action>
**ci.yaml modifications:**

1. Add `security-events: write` to the workflow-level `permissions` block (required for the called workflow to inherit this permission):
   ```yaml
   permissions:
     contents: read
     security-events: write
   ```

2. Add a new `security` job after the `changes` job:
   ```yaml
   security:
     name: Security Scans
     uses: ./.github/workflows/security.yaml
     permissions:
       security-events: write
       contents: read
     with:
       scan-mode: diff
   ```
   - No `needs` dependency — security scans run in parallel with frontend/backend/e2e jobs (they only need the repo checkout, not build results)
   - Do NOT add security to the `needs` array of any existing job (it must not block anything)

**nightly.yaml modifications:**

1. Add `security-events: write` to the workflow-level `permissions` block:
   ```yaml
   permissions:
     contents: read
     issues: write
     security-events: write
   ```

2. Add a new `security-scans` job (independent of existing jobs, no `needs`):
   ```yaml
   security-scans:
     name: Security Scans (Full)
     uses: ./.github/workflows/security.yaml
     permissions:
       security-events: write
       contents: read
     with:
       scan-mode: full
   ```
   Place it before the `create-issues` job in the file but do NOT add it to the `create-issues` job's `needs` array (security scan failures are handled via Security tab, not issue creation).

Key constraints:
- Read existing file content before modifying (preserve all existing jobs exactly as-is)
- Do NOT change any existing job definitions, permissions, or dependencies
- Do NOT add security to existing jobs' `needs` arrays
- The security job must not block any existing workflow behavior
  </action>
  <verify>
Validate both YAML files parse correctly:
- `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yaml'))"`
- `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/nightly.yaml'))"`

Verify ci.yaml contains:
- `security-events: write` in workflow-level permissions
- A `security` job with `uses: ./.github/workflows/security.yaml`
- `scan-mode: diff` input

Verify nightly.yaml contains:
- `security-events: write` in workflow-level permissions
- A `security-scans` job with `uses: ./.github/workflows/security.yaml`
- `scan-mode: full` input

Verify existing jobs in both files are unchanged (spot-check: `changes` job in ci.yaml still has same outputs, `create-issues` in nightly.yaml still has same `needs` array).
  </verify>
  <done>
ci.yaml calls security.yaml with scan-mode: diff, runs in parallel with existing jobs, does not block anything. nightly.yaml calls security.yaml with scan-mode: full, runs independently of existing nightly jobs. Both callers have security-events: write permission. All existing job definitions unchanged.
  </done>
</task>

</tasks>

<verification>
1. All three YAML files parse without syntax errors
2. `security.yaml` contains workflow_call trigger, Semgrep Docker container job, SARIF upload with category
3. `ci.yaml` calls security.yaml and has correct permissions
4. `nightly.yaml` calls security.yaml and has correct permissions
5. No existing CI behavior changed (all existing jobs, triggers, permissions, dependencies preserved)
6. All Actions are SHA-pinned (no tag references like @v6)
7. Semgrep job has continue-on-error: true
8. Job-level permissions used (not workflow-level escalation for security-events on security.yaml itself)
</verification>

<success_criteria>
- security.yaml exists as a reusable workflow with Semgrep SAST job
- ci.yaml invokes security.yaml on PRs and pushes to main with scan-mode: diff
- nightly.yaml invokes security.yaml with scan-mode: full
- All third-party Actions pinned to commit SHAs
- Semgrep uses native Docker container with --config auto --sarif
- SARIF uploads to Security tab with category "semgrep"
- Security scans are non-blocking (continue-on-error: true)
- Job-level least-privilege permissions throughout
- Existing CI and nightly behavior completely unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-sast/01-01-SUMMARY.md`
</output>
