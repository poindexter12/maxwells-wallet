---
phase: 14-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yaml
  - .github/workflows/nightly.yaml
  - .github/workflows/nightly-e2e.yaml
  - .github/workflows/nightly-chaos.yaml
  - .github/workflows/nightly-performance.yaml
  - .github/workflows/weekly-endurance.yaml
  - .github/workflows/dast.yaml
autonomous: true
requirements: [CI-01, CI-02, CI-03]

must_haves:
  truths:
    - "All GitHub Actions workflows use jdx/mise-action@v2 instead of setup-node/setup-uv/setup-python"
    - "All workflow commands call just recipes instead of inline bash"
    - "Gum non-interactive fallback works in CI (no TTY hangs)"
    - "CI jobs produce identical functional outcomes as before (tests run, artifacts upload, coverage reports)"
  artifacts:
    - path: ".github/workflows/ci.yaml"
      provides: "Main CI pipeline with mise + just"
      contains: "jdx/mise-action"
    - path: ".github/workflows/nightly.yaml"
      provides: "Nightly quality checks with mise + just"
      contains: "jdx/mise-action"
    - path: ".github/workflows/nightly-e2e.yaml"
      provides: "Nightly E2E tests with mise + just"
      contains: "jdx/mise-action"
    - path: ".github/workflows/nightly-chaos.yaml"
      provides: "Chaos tests with mise + just"
      contains: "jdx/mise-action"
    - path: ".github/workflows/nightly-performance.yaml"
      provides: "Performance tests with mise + just"
      contains: "jdx/mise-action"
    - path: ".github/workflows/weekly-endurance.yaml"
      provides: "Endurance tests with mise + just"
      contains: "jdx/mise-action"
    - path: ".github/workflows/dast.yaml"
      provides: "DAST scanning with mise + just for docker commands"
      contains: "jdx/mise-action"
  key_links:
    - from: ".github/workflows/ci.yaml"
      to: ".mise.toml"
      via: "jdx/mise-action reads tool versions from .mise.toml"
      pattern: "jdx/mise-action"
    - from: ".github/workflows/ci.yaml"
      to: "justfile"
      via: "just recipe calls replace inline bash commands"
      pattern: "just (install|test::|db::|dev::|docker::|i18n::)"
---

<objective>
Migrate all GitHub Actions workflow files from individual tool setup actions (setup-node, setup-uv, setup-python) to jdx/mise-action@v2, and replace all inline bash commands with just recipe calls.

Purpose: Unify CI tool management through mise (single source of truth for tool versions) and ensure local dev commands match CI commands exactly via just recipes.

Output: 7 updated workflow YAML files using mise-action + just recipes.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-integration/14-RESEARCH.md

<interfaces>
<!-- Key patterns from Phase 13 that CI recipes must match -->

From justfile (root):
- `just setup` — install + db::init + db::seed
- `just install` — install-backend + install-frontend
- `just install-backend` — uv venv + uv sync in backend/
- `just install-frontend` — npm install in frontend/

From .just/test.just:
- `just test::backend` — pytest (ignores e2e and performance)
- `just test::coverage` — pytest with --cov
- `just test::lint-frontend` — npm run lint
- `just test::lint-backend` — ruff check
- `just test::vulture` / `just test::dead-code` — vulture dead code
- `just test::typecheck` — mypy
- `just test::e2e` — playwright E2E (checks for running servers)
- `just test::e2e-install` — install playwright browsers
- `just test::chaos` — chaos tests
- `just test::perf` — performance tests
- `just test::security-audit` — pip-audit

From .just/db.just:
- `just db::init` — create tables
- `just db::seed` — insert seed data

From .just/docker.just:
- `just docker::build` — docker compose build
- `just docker::up` — docker compose up -d
- `just docker::down` — docker compose down
- `just docker::clean` — docker compose down -v
- `just docker::migrate` — run migrate in container
- `just docker::seed` — run seed in container

From .just/i18n.just:
- `just i18n::pseudo` — generate pseudo-locale

From .just/dev.just:
- `just dev::build-frontend` — npm run build in frontend/

Key: gum-helpers.sh `is_tty()` returns false in CI (no stdout TTY), so all gum commands fallback to plain text output.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ci.yaml to mise-action + just recipes</name>
  <files>.github/workflows/ci.yaml</files>
  <action>
Update `.github/workflows/ci.yaml` to use mise-action and just recipes. Apply these changes to each job:

**Frontend job:**
- Remove `defaults.run.working-directory: frontend`
- Replace `actions/setup-node` step with:
  ```yaml
  - name: Setup mise
    uses: jdx/mise-action@v2
    with:
      install: true
  ```
- Replace `npm ci` with `just install-frontend`
- Replace `node scripts/generate-pseudo-locale.mjs` with `just i18n::pseudo`
- Replace `npm run lint` with `just test::lint-frontend`
- Replace `npm run test:run` with: `cd frontend && npm run test:run` (keep direct — the just test recipes are for backend pytest, not vitest; the frontend `test:run` is a vitest command that doesn't have a matching just recipe)
- Replace `npm run build` with `just dev::build-frontend`
- Remove `GITHUB_TOKEN` env from install step (just recipe handles it)

**Backend job:**
- Remove `defaults.run.working-directory: backend`
- Replace `astral-sh/setup-uv` + `uv python install` steps with mise-action step
- Replace `uv sync` with `just install-backend`
- Replace `uv run ruff check .` with `just test::lint-backend`
- Replace `uv run vulture app` with `just test::dead-code`
- Replace `uv run mypy app` with `just test::typecheck`
- Replace pytest command with `just test::coverage`
- Update Codecov upload step: keep `files: ./backend/coverage.xml` path (coverage.xml generated by just recipe, but the just recipe currently generates html+term reports, not xml). IMPORTANT: The CI needs `--cov-report=xml` for Codecov. Override the just recipe here by using direct command instead: `cd backend && uv run pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing --ignore=tests/e2e --ignore=tests/performance`. This is acceptable — the just recipe is for local dev (html report), CI needs xml format.

**E2E job:**
- Replace `actions/setup-node` + `astral-sh/setup-uv` + `uv python install` with single mise-action step
- Replace separate backend/frontend install steps with `just install`
- Replace `mkdir -p data` + `uv run python -m scripts.init_db` with `just db::init`
- Replace `uv run python -m scripts.seed` with `just db::seed`
- Remove all `working-directory` directives from steps that now use just
- Replace `npx playwright install --with-deps chromium` with direct command (keep as-is — frontend Playwright, not backend)
- Replace `npx playwright test --grep "@e2e" --project=chromium` (keep as-is — frontend Playwright test with specific flags)
- Keep `DATABASE_URL` env vars on db init/seed steps — wait, the just recipes don't pass DATABASE_URL. Check: the just db::init recipe uses `uv run python -c "import asyncio; from app.database import init_db; asyncio.run(init_db())"` which reads DATABASE_URL from env. In CI, we need to set it. Add `env: DATABASE_URL` to the just db::init and just db::seed steps.
- Keep the Playwright install/test steps as working-directory: frontend with direct npx commands (these are frontend Playwright, not backend test recipes)

**Performance job:**
- Replace `astral-sh/setup-uv` + `uv python install` with mise-action
- Replace `uv sync` with `just install-backend`
- Replace pytest performance command with `just test::perf` (but keep the GITHUB_STEP_SUMMARY echo lines as a separate run step after)
- Keep `working-directory: backend` only for artifact upload path resolution
- Keep `OTEL_ENABLED: "false"` env var on the perf test step

**Docker job:**
- Add mise-action step after checkout (just binary needed for recipe calls)
- Replace `docker compose -f docker-compose.dev.yaml down -v --remove-orphans` with `just docker::clean` — WAIT: docker::clean has a gum confirm prompt. In CI (non-TTY), the confirm fallback returns default which is `false` — meaning it would skip the clean. This is a problem. Use direct docker compose command here instead: `docker compose -f docker-compose.dev.yaml down -v --remove-orphans 2>/dev/null || true`
- Replace `docker compose -f docker-compose.dev.yaml build` with `just docker::build`
- Replace migrate/seed docker-compose run commands with `just docker::migrate` and `just docker::seed`
- Replace health check `docker compose up -d` section with `just docker::up` followed by inline health check loop (keep the health check logic inline — it's CI-specific with retry loops and failure logging)
- Keep the remaining Docker steps as-is (Trivy scan, Buildx setup, GHCR login, build-and-push — these are CI-specific actions)
- Keep `docker compose -f docker-compose.dev.yaml logs` in failure handlers (simple one-liners)
- Keep cleanup step as direct docker compose command (same confirm issue)

**Changes job (detect changes):** No changes needed — just path filtering.

**Security job:** No changes needed — calls reusable workflow.
  </action>
  <verify>
    <automated>cd /Users/joe/Code/github.com/poindexter12/maxwells-wallet && grep -c "jdx/mise-action" .github/workflows/ci.yaml && grep -c "actions/setup-node" .github/workflows/ci.yaml | grep -q "^0$" && grep -c "astral-sh/setup-uv" .github/workflows/ci.yaml | grep -q "^0$" && echo "PASS"</automated>
  </verify>
  <done>ci.yaml uses mise-action for all tool setup, just recipes for most commands, no remaining setup-node or setup-uv actions. Docker job's destructive cleanup and health check logic preserved inline where gum confirm fallback would interfere.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate nightly, chaos, performance, endurance, and DAST workflows</name>
  <files>
    .github/workflows/nightly.yaml
    .github/workflows/nightly-e2e.yaml
    .github/workflows/nightly-chaos.yaml
    .github/workflows/nightly-performance.yaml
    .github/workflows/weekly-endurance.yaml
    .github/workflows/dast.yaml
  </files>
  <action>
Apply the same mise-action + just recipe pattern to all remaining workflow files. The transformation is mechanical and follows the same rules as Task 1.

**nightly.yaml** — 4 jobs (security-audit, dead-code-analysis, code-quality, coverage-check):
Each job has identical setup: checkout → setup-uv → python install → uv sync. Replace with:
```yaml
- uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
- name: Setup mise
  uses: jdx/mise-action@v2
  with:
    install: true
- name: Install dependencies
  run: just install-backend
```
- Remove `defaults.run.working-directory: backend` from all 4 jobs
- **security-audit job:** Replace inline pip-audit with `just test::security-audit`. BUT: the existing job writes to `$GITHUB_STEP_SUMMARY`. The just recipe doesn't do that. Keep the inline script but change the uv run pip-audit call: use `cd backend && uv run pip-audit` after mise setup. Actually, simpler: keep the inline scripts for GITHUB_STEP_SUMMARY formatting (CI-specific), but prefix all `uv run` commands with `cd backend &&`.
- **dead-code-analysis job:** Same pattern — keep GITHUB_STEP_SUMMARY script, adjust paths with `cd backend &&`.
- **code-quality job:** Same pattern for ruff and mypy steps.
- **coverage-check job:** Same pattern for pytest step with `--cov-fail-under=85`.
- The `create-issues` job needs no changes (just GitHub CLI calls).

**nightly-e2e.yaml:**
- Replace `actions/setup-node` + `astral-sh/setup-uv` + `uv python install` with mise-action
- Replace separate backend dependency install + db setup steps with `just install-backend`, `just db::init`, `just db::seed`
- Replace frontend dependency install with `just install-frontend`
- Remove `working-directory` directives from just recipe steps
- Keep `GITHUB_TOKEN` env for install-frontend step (rate limit protection) — but just install-frontend doesn't accept env vars. Use `GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} just install-frontend` or keep the npm ci command with working-directory for this specific case.
- Keep Playwright install/test steps as direct `npx` commands with `working-directory: frontend` (browser-specific matrix logic)
- Keep `DATABASE_URL` env vars on db init/seed steps
- Keep artifact upload steps unchanged

**nightly-chaos.yaml:**
- Same mise-action replacement pattern
- Replace backend dependency install + db setup with just recipes
- Replace frontend dependency install (has retry loop) — keep the retry loop but replace `npm ci` with `cd frontend && npm ci` after removing working-directory. OR keep as-is since the retry logic is CI-specific.
- Keep Playwright install with retry loops as-is (CI-specific retry logic)
- Keep Playwright test command as-is (specific spec/project/workers flags)
- Keep `working-directory: frontend` for Playwright steps

**nightly-performance.yaml:**
- Replace `astral-sh/setup-uv` + `uv python install` with mise-action
- Replace `uv sync` with `just install-backend`
- Replace pytest performance command: keep inline for GITHUB_STEP_SUMMARY support
- Remove `defaults.run.working-directory: backend` (but add `cd backend &&` to inline commands)
- Keep artifact upload unchanged

**weekly-endurance.yaml:**
- Same mise-action replacement pattern
- Replace backend/frontend setup steps with just recipes
- Keep grep pattern determination step unchanged
- Keep Playwright test command as-is
- Keep artifact upload unchanged

**dast.yaml:**
- Add mise-action step after checkout
- Replace `docker compose -f docker-compose.dev.yaml up -d --build` with `just docker::build && just docker::up`
- Keep health check loop inline (CI-specific retry logic)
- Keep ZAP scan and cleanup steps unchanged
- Replace `docker compose -f docker-compose.dev.yaml down -v --remove-orphans` in cleanup with direct command (same gum confirm issue as ci.yaml)

**For ALL workflows:** Verify no `actions/setup-node`, `actions/setup-python` (except docs.yaml which is out of scope), or `astral-sh/setup-uv` remains. Every workflow that runs application code uses `jdx/mise-action@v2` with `install: true`.
  </action>
  <verify>
    <automated>cd /Users/joe/Code/github.com/poindexter12/maxwells-wallet && for f in nightly.yaml nightly-e2e.yaml nightly-chaos.yaml nightly-performance.yaml weekly-endurance.yaml dast.yaml; do echo "--- $f ---" && grep -c "jdx/mise-action" .github/workflows/$f && grep -c "astral-sh/setup-uv" .github/workflows/$f; done</automated>
  </verify>
  <done>All 6 remaining workflow files use mise-action for tool setup. No astral-sh/setup-uv or actions/setup-node references remain (except where explicitly excluded like docs.yaml). GITHUB_STEP_SUMMARY formatting preserved for nightly quality jobs. CI-specific retry loops and artifact paths preserved.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -r "actions/setup-node" .github/workflows/` returns only `docs.yaml` (excluded from migration)
2. `grep -r "astral-sh/setup-uv" .github/workflows/` returns zero results
3. `grep -r "jdx/mise-action" .github/workflows/` returns matches in ci.yaml, nightly.yaml, nightly-e2e.yaml, nightly-chaos.yaml, nightly-performance.yaml, weekly-endurance.yaml, dast.yaml
4. `grep -c "just " .github/workflows/ci.yaml` shows multiple just recipe invocations
5. No workflow uses `uv python install` anymore
</verification>

<success_criteria>
- All 7 workflow files updated to use jdx/mise-action@v2 with install: true
- Inline bash commands replaced with just recipe calls where appropriate
- CI-specific logic preserved (GITHUB_STEP_SUMMARY, retry loops, artifact uploads, health checks)
- Docker cleanup steps keep direct commands (avoid gum confirm fallback issue)
- Codecov coverage upload path preserved
</success_criteria>

<output>
After completion, create `.planning/phases/14-integration/14-01-SUMMARY.md`
</output>
