---
phase: 11-backend-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/orm.py
  - backend/alembic/versions/*_utc_timezone_migration.py
autonomous: true
requirements: [BACK-01, BACK-02]

must_haves:
  truths:
    - "All datetime fields store timezone-aware UTC timestamps"
    - "Existing timezone-naive data converted to UTC-aware without data loss"
    - "New records automatically created with UTC-aware timestamps"
  artifacts:
    - path: "backend/app/orm.py"
      provides: "TimestampMixin with timezone-aware DateTime columns"
      contains: "DateTime(timezone=True)"
      min_lines: 40
    - path: "backend/alembic/versions/*_utc_timezone_migration.py"
      provides: "Alembic migration converting naive datetimes to UTC-aware"
      exports: ["upgrade", "downgrade"]
  key_links:
    - from: "backend/app/orm.py"
      to: "TimestampMixin.created_at"
      via: "DateTime(timezone=True)"
      pattern: "DateTime\\(timezone=True"
    - from: "backend/alembic/versions/*_utc_timezone_migration.py"
      to: "existing data"
      via: "data migration SQL"
      pattern: "ALTER TABLE.*created_at"
---

<objective>
Make all datetime fields timezone-aware using UTC to prepare for Postgres migration.

Purpose: SQLite without timezone awareness can cause data corruption when migrating to Postgres. Explicit UTC timestamps prevent timezone-related bugs and ensure consistent behavior across SQLite and Postgres.

Output: TimestampMixin with timezone-aware columns and Alembic migration converting existing data.
</objective>

<execution_context>
@/Users/joe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/orm.py
@backend/app/schemas.py
@backend/alembic/env.py
</context>

<tasks>

<task type="auto">
  <name>Add timezone=True to DateTime columns in TimestampMixin</name>
  <files>backend/app/orm.py</files>
  <action>
Update TimestampMixin class (currently lines 38-44) to use timezone-aware DateTime columns:

**Current code:**
```python
class TimestampMixin:
    """Mixin providing created_at and updated_at timestamps."""

    created_at: Mapped[datetime] = mapped_column(DateTime, default=func.now())
    updated_at: Mapped[datetime] = mapped_column(
        DateTime, default=func.now(), onupdate=func.now()
    )
```

**Change to:**
```python
class TimestampMixin:
    """Mixin providing created_at and updated_at timestamps."""

    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=func.now())
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), default=func.now(), onupdate=func.now()
    )
```

Also check for any other `mapped_column(DateTime` usages in orm.py and add `timezone=True` to all of them. Currently there's one at line 385 in Dashboard model (`last_used_at`) and line 313 in TagRule model (`last_matched_date`).

**Important:** Do NOT change any imports or add `datetime.now(timezone.utc)` calls in orm.py â€” the migration will handle existing data, and SQLAlchemy's `func.now()` will handle new records correctly with the timezone-aware column type.
  </action>
  <verify>grep -n "DateTime(timezone=True)" backend/app/orm.py should show all DateTime columns using timezone=True</verify>
  <done>TimestampMixin and all other DateTime columns use timezone-aware types</done>
</task>

<task type="auto">
  <name>Create Alembic migration to convert existing data to UTC-aware</name>
  <files>backend/alembic/versions/*_utc_timezone_migration.py</files>
  <action>
Create new Alembic migration to handle timezone-aware conversion:

From backend/ directory, run:
```bash
uv run alembic revision -m "convert datetime columns to timezone aware utc"
```

Then edit the generated migration file to:

**Upgrade:**
1. For SQLite: ALTER TABLE statements are limited, so we need to handle this in Python with data migration. Read all rows, parse datetime strings as UTC, write back.
2. For Postgres: Use `ALTER TABLE ... ALTER COLUMN ... TYPE TIMESTAMP WITH TIME ZONE` for each affected column.

**Tables to migrate:**
- transactions (created_at, updated_at)
- tags (created_at, updated_at)
- budgets (created_at, updated_at)
- tag_rules (created_at, updated_at, last_matched_date)
- recurring_patterns (created_at, updated_at)
- merchant_aliases (created_at, updated_at)
- saved_filters (created_at, updated_at)
- dashboards (created_at, updated_at, last_used_at)
- dashboard_widgets (created_at, updated_at)
- import_sessions (created_at, updated_at)
- batch_import_sessions (created_at, updated_at)
- import_formats (created_at, updated_at)
- custom_format_configs (created_at, updated_at)
- app_settings (created_at, updated_at)
- users (created_at, updated_at)

**Migration approach:**
For SQLite compatibility, use a Python-based migration that:
1. Reads existing datetime values
2. Assumes they are UTC (naive datetimes without timezone)
3. Explicitly marks them as UTC-aware by adding `+00:00` timezone suffix
4. Updates the rows

For Postgres (when we migrate), the `timezone=True` in SQLAlchemy will create `TIMESTAMP WITH TIME ZONE` columns automatically, so this data migration ensures existing SQLite data has proper UTC markers.

**Downgrade:**
Document that downgrade removes timezone awareness (safe for SQLite, but data may lose timezone info on Postgres).

**Pattern reference:** Check existing migrations in backend/alembic/versions/ for the standard structure and naming pattern.
  </action>
  <verify>uv run alembic upgrade head should run without errors; uv run alembic downgrade -1 should also work</verify>
  <done>Alembic migration exists, runs successfully, and converts all existing datetime data to UTC-aware</done>
</task>

</tasks>

<verification>
Run from backend/ directory:

1. Type check: `uv run mypy app/orm.py --no-error-summary` (no new errors)
2. Migration test: `uv run alembic upgrade head` (no errors)
3. Verify timezone awareness: Check that SQLAlchemy queries return datetime objects with `tzinfo=UTC`
4. Backend tests: `make test-backend` (existing tests should pass)
</verification>

<success_criteria>
- [ ] All DateTime columns in orm.py use `DateTime(timezone=True)`
- [ ] Alembic migration runs successfully on fresh SQLite database
- [ ] Alembic migration converts existing naive datetimes to UTC-aware
- [ ] Backend tests pass without timezone-related errors
- [ ] BACK-01 satisfied: All datetime fields use timezone-aware UTC
- [ ] BACK-02 satisfied: Migration converts existing data to UTC-aware
</success_criteria>

<output>
After completion, create `.planning/phases/11-backend-hardening/11-01-SUMMARY.md`
</output>
